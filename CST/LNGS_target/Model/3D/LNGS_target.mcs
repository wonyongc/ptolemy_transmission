Option Explicit

Dim max_time_steps, trajectory_sampling_step_frequency, trajectory_spatial_sampling_per_mesh_step _
	As Integer
Dim boundarytype, b_field_file, e_field_file _
	As String
Dim magnetrun, Eimport, Bimport, ComputeE, ComputeB, SaveTraj _
	As Boolean
Dim n_electrodes, _
	n_electrodes_filter_stage_1_end, n_electrodes_filter_stage_2_end, n_electrodes_filter_stage_3_end, n_electrodes_filter_stage_4_end, n_electrodes_filter_stage_5_end, _
	n_electrode_overlap_between_filter_stages, _
	n_electrodes_accel_region_end, n_electrodes_filter_region_start _
	As Integer
Dim global_background_space_buffer, zmin_background_space_buffer, zmax_background_space_buffer _
	As Double
Dim	electrode_thickness, electrode_length_z, electrode_gap_z, electrode_step_z, _
	filter_dimension_half_x, filter_dimension_half_y_stage_1, filter_dimension_half_y_stage_2, filter_dimension_half_y_stage_3, filter_dimension_half_y_stage_4, filter_dimension_half_y_stage_5, _
	filter_electrodes_z_end_stage_1, bounce_electrodes_z_end_stage_1, _
	filter_electrodes_z_end_stage_2, bounce_electrodes_z_end_stage_2, _
	filter_electrodes_z_end_stage_3, bounce_electrodes_z_end_stage_3, _
	filter_electrodes_z_end_stage_4, bounce_electrodes_z_end_stage_4, _
	filter_electrodes_z_end_stage_5, bounce_electrodes_z_end_stage_5, _
	bounce_electrodes_z_start_stage_2, filter_electrodes_z_start_stage_2, _
	bounce_electrodes_z_start_stage_3, filter_electrodes_z_start_stage_3, _
	bounce_electrodes_z_start_stage_4, filter_electrodes_z_start_stage_4, _
	bounce_electrodes_z_start_stage_5, filter_electrodes_z_start_stage_5, _
	termination_backplate_z_pos _
	As Double
Dim perm_magnet_x, perm_magnet_z, perm_magnet_remnance, perm_magnet_rotation_deg, perm_magnet_radius, target_cylinder_height _
	As Double
Dim Bx_Normalized(150), Bx_Lambda_Adjusted_Filter(150), Bx_Lambda_Adjusted_Bounce(150) _
	As Double
Dim particle_start_x, particle_start_y, particle_start_z _
	As Double
Dim uniform_mesh_step_x_global, uniform_mesh_step_y_global, uniform_mesh_step_z_global, _
	filter_mesh_dimension_half_x, filter_mesh_dimension_half_y, filter_mesh_z_start, filter_mesh_z_end, _
	injection_mesh_x_start, injection_mesh_x_end, injection_mesh_z_start _
	As Double
Dim LNGS_Magnet_Material As String
Dim target_cylinder_voltage_inner, target_backscatter_catcher_voltage As Double
Dim i, j, k, z As Integer
Dim x1, x2, z1, z2 As Double
Dim injection_bounce_voltage, bv_top, bv_bot, _
	injection_potential_1, injection_potential_2, injection_potential_3, injection_potential_4, injection_potential_5, _
	injection_half_drift_voltage_1, injection_half_drift_voltage_2, injection_half_drift_voltage_3, injection_half_drift_voltage_4, injection_half_drift_voltage_5, _
	negy1t, negy2t, negy3t, negy4t, negy5t, _
	vscale1, vscale2, vscale3, vscale4, vscale5, _
	electron_injection_z_position_nominal, injection_electrode_z_length_forward_from_electron_injection, injection_electrode_z_length_backward_from_electron_injection, _
	injection_electrode_z_start, injection_electrode_z_end, zstart, _
	accel_negy, accel_posy, scale_adj, offset, maxfrac As Double
Dim particle_ring_emission_radius_inner, particle_ring_emission_radius_outer, particle_ring_emission_lines_n, _
	particle_ring_emission_theta, particle_ring_emission_phi, particle_ring_emission_theta_spread_plusminus As Double
Dim crot, catchxgap, catchz, Rcatchshell, _
	catchVbase, catchVinner, catchVouter, catchVcatcher, backplateV, _
	catchVring1, catchVring2, catchVring3, backring1V, bring_cutout_y, _
	bring_cutout_z, ringstartx, ringlen1, ringlen2, ringlen3, _
	Rcatcher_catcher As Double


Public Sub Main ()

	Define_Bx_Normalized_Values()
	Define_Bx_Lambda_Adjusted_Values_Filter()
	Define_Bx_Lambda_Adjusted_Values_Bounce()

''''''''''''''''''''''''''''''''''''''''''' Permanent Magnet Target
	perm_magnet_z            = -1.302
	perm_magnet_x            = -0.253
	perm_magnet_remnance     = 15*0.1017
	perm_magnet_rotation_deg = 74.07

	perm_magnet_radius       = 0.01
	target_cylinder_height   = 0.005

	target_cylinder_voltage_inner      = 18600
	target_backscatter_catcher_voltage = 19000

''''''''''''''''''''''''''''''''''''''''''' Parallel Drain and Injection Electrodes

	electron_injection_z_position_nominal = -1.521275
	injection_electrode_z_length_forward_from_electron_injection	= 0.10
	injection_electrode_z_length_backward_from_electron_injection	= 0.03

	injection_electrode_z_start= electron_injection_z_position_nominal-injection_electrode_z_length_backward_from_electron_injection
	injection_electrode_z_end  = electron_injection_z_position_nominal+injection_electrode_z_length_forward_from_electron_injection

	injection_bounce_voltage = -200

	injection_potential_5 = 0
	injection_potential_4 = 100
	injection_potential_3 = 200
	injection_potential_2 = 800
	injection_potential_1 = 1500

	injection_half_drift_voltage_5 = 2500
	injection_half_drift_voltage_4 = 2500
	injection_half_drift_voltage_3 = 2500
	injection_half_drift_voltage_2 = 2500
	injection_half_drift_voltage_1 = 2500

	negy5t = 0
	negy4t = 0
	negy3t = 0
	negy2t = 0
	negy1t = 0

	vscale5   = (injection_potential_5+injection_half_drift_voltage_5)/Bx_Normalized(0)
	vscale4   = (injection_potential_4+injection_half_drift_voltage_4)/Bx_Normalized(0)
	vscale3   = (injection_potential_3+injection_half_drift_voltage_3)/Bx_Normalized(0)
	vscale2   = (injection_potential_2+injection_half_drift_voltage_2)/Bx_Normalized(0)
	vscale1   = (injection_potential_1+injection_half_drift_voltage_1)/Bx_Normalized(0)

	offset = 0.10
	maxfrac = 0.40

''''''''''''''''''''''''''''''''''''''''''' Filter and Bounce Electrodes
	electrode_thickness = 0.001
	electrode_length_z 	= 0.016
	electrode_gap_z 	= 0.004
	electrode_step_z 	= electrode_length_z +electrode_gap_z

	n_electrodes_filter_stage_1_end = 100
	n_electrodes_filter_stage_2_end = 110
	n_electrodes_filter_stage_3_end = 120
	n_electrodes_filter_stage_4_end = 130
	n_electrodes_filter_stage_5_end = 140

	n_electrode_overlap_between_filter_stages = 3

	filter_dimension_half_x       	= 0.055

	filter_dimension_half_y_stage_1 = 0.020
	filter_dimension_half_y_stage_2	= 0.030
	filter_dimension_half_y_stage_3	= 0.040
	filter_dimension_half_y_stage_4	= 0.050
	filter_dimension_half_y_stage_5	= 0.060

	' The region in which the lambda adjusted accelerating voltages are applied, starting from 0
	n_electrodes_accel_region_end    = 38

	' The starting electrode index from which the lambda adjusted filter voltages are applied
	n_electrodes_filter_region_start = 50

	bounce_electrodes_z_end_stage_1     = injection_electrode_z_end +n_electrodes_filter_stage_1_end*electrode_step_z
	bounce_electrodes_z_start_stage_2   = bounce_electrodes_z_end_stage_1
	bounce_electrodes_z_end_stage_2     = injection_electrode_z_end +n_electrodes_filter_stage_2_end*electrode_step_z
	bounce_electrodes_z_start_stage_3   = bounce_electrodes_z_end_stage_2
	bounce_electrodes_z_end_stage_3     = injection_electrode_z_end +n_electrodes_filter_stage_3_end*electrode_step_z
	bounce_electrodes_z_start_stage_4   = bounce_electrodes_z_end_stage_3
	bounce_electrodes_z_end_stage_4     = injection_electrode_z_end +n_electrodes_filter_stage_4_end*electrode_step_z
	bounce_electrodes_z_start_stage_5   = bounce_electrodes_z_end_stage_4
	bounce_electrodes_z_end_stage_5     = injection_electrode_z_end +n_electrodes_filter_stage_5_end*electrode_step_z

	filter_electrodes_z_end_stage_1    = injection_electrode_z_end +(n_electrodes_filter_stage_1_end+n_electrode_overlap_between_filter_stages)*electrode_step_z
	filter_electrodes_z_start_stage_2  = injection_electrode_z_end +n_electrodes_filter_stage_1_end*electrode_step_z
	filter_electrodes_z_end_stage_2    = injection_electrode_z_end +(n_electrodes_filter_stage_2_end+n_electrode_overlap_between_filter_stages)*electrode_step_z
	filter_electrodes_z_start_stage_3  = injection_electrode_z_end +n_electrodes_filter_stage_2_end*electrode_step_z
	filter_electrodes_z_end_stage_3    = injection_electrode_z_end +(n_electrodes_filter_stage_3_end+n_electrode_overlap_between_filter_stages)*electrode_step_z
	filter_electrodes_z_start_stage_4  = injection_electrode_z_end +n_electrodes_filter_stage_3_end*electrode_step_z
	filter_electrodes_z_end_stage_4    = injection_electrode_z_end +(n_electrodes_filter_stage_4_end+n_electrode_overlap_between_filter_stages)*electrode_step_z
	filter_electrodes_z_start_stage_5  = injection_electrode_z_end +n_electrodes_filter_stage_4_end*electrode_step_z
	filter_electrodes_z_end_stage_5    = injection_electrode_z_end +n_electrodes_filter_stage_5_end*electrode_step_z

	termination_backplate_z_pos = filter_electrodes_z_end_stage_5

''''''''''''''''''''''''''''''''''''''''''' Uniform Mesh

	uniform_mesh_step_x_global = electrode_thickness
	uniform_mesh_step_y_global = electrode_thickness
	uniform_mesh_step_z_global = electrode_thickness

	filter_mesh_dimension_half_x = filter_dimension_half_x+5*electrode_thickness
	filter_mesh_dimension_half_y = filter_dimension_half_y_stage_5+5*electrode_thickness

	filter_mesh_z_start = -1.2
	filter_mesh_z_end   = 1.5

	injection_mesh_z_start = -1.6
	injection_mesh_x_start = -0.36
	injection_mesh_x_end = filter_mesh_dimension_half_x

''''''''''''''''''''''''''''''''''''''''''' B/E field imports

	b_field_file = "/scratch/gpfs/wonyongc/lngs_target/magnet_runs/lngs_3perm_asym.cst"

	' e_field_file = "/scratch/gpfs/wonyongc/lngs_target/5stage_post60.cst"

''''''''''''''''''''''''''''''''''''''''''' Trajectories

	SaveTraj = False
	max_time_steps = 100000000
	trajectory_sampling_step_frequency = 100
	trajectory_spatial_sampling_per_mesh_step = 100 ' Min pushes per cell - 50

''''''''''''''''''''''''''''''''''''''''''' Background Volume
	boundarytype = "open"
	global_background_space_buffer = 0.1
	zmin_background_space_buffer = 0.1
	zmax_background_space_buffer = 0.1
	
''''''''''''''''''''''''''''''''''''''''''' Magnet Run Toggle
	
	magnetrun = False

	If magnetrun = True Then
		filter_mesh_dimension_half_y = Rcatchshell
		max_time_steps = 100000
		zmin_background_space_buffer = 0.4 ' from injection_electrode_z_start at -1.55
		zmax_background_space_buffer = 1.0 ' from horn z at 0.65
	End If


''''''''''''''''''''''''''''''''''''''''''' subroutines
	DefineMaterials()
	DefineComponents()

	LNGS_Magnet_Material = "Iron-PEC"

	Make_LNGS_Magnet()
	Make_Permanent_Magnet_Target()

	Make_Target_Cylinder_Electrodes()
	Make_Parallel_Drain_Electrodes()
	Make_Injection_Electrodes()

	Make_Filter_Stage_1_PCBs()
	Make_Filter_Stage_1_Electrodes()
	Make_Filter_Stage_2_PCBs()
	Make_Filter_Stage_2_Electrodes()
	Make_Filter_Stage_3_PCBs()
	Make_Filter_Stage_3_Electrodes()
	Make_Filter_Stage_4_PCBs()
	Make_Filter_Stage_4_Electrodes()
	Make_Filter_Stage_5_PCBs()
	Make_Filter_Stage_5_Electrodes()
	
	' Make_Backplate_PCB()

	Make_Uniform_Mesh()

	' 10,200 particles
	particle_ring_emission_theta = 20
	particle_ring_emission_theta_spread_plusminus = 5

	' particle_ring_emission_phi = pringphiplaceholder
	particle_ring_emission_phi = 0

	particle_ring_emission_radius_inner = 0.000001
	particle_ring_emission_radius_outer = 0.001
	particle_ring_emission_lines_n = 50

	Make_Test_Particles()
	' Make_Particle_Ring_Emission()

	' Compute_Bfield_Only_No_Efield()
	Import_Bfield_Compute_Efield()
	' Import_Bfield_Import_Efield()

	SetSolvers()
	SetPTTracking()
	SetPTMonitors()

	If magnetrun = False Then
		Group.AddItem "solid$magnet:lngs_magnet", "Excluded from Simulation"
		Group.AddItem "solid$magnet:lngs_magnet", "Excluded from Bounding Box"
		Group.AddItem "coil$coil1", "Excluded from Simulation"
		Group.AddItem "coil$coil1", "Excluded from Bounding Box"
		Group.AddItem "coil$coil1_1", "Excluded from Simulation"
		Group.AddItem "coil$coil1_1", "Excluded from Bounding Box"
	End If

End Sub


''''''' LNGS Magnet

Sub Make_LNGS_Magnet()

	With Polygon3D
		.Reset
		.Name "lngs_cross_section"
		.Curve "magnet_curve"
		.Point 1.25, 0.3, 0 
		.Point 1.25, -1.1, 0 
		.Point 1.05, -1.3, 0 
		.Point -1.05, -1.3, 0 
		.Point -1.25, -1.1, 0 
		.Point -1.25, 0.3, 0 
		' .Point -0.125, 0.3, 0 
		' .Point -0.075, 0.25, 0
		.Point -0.075, 0.3, 0 
		' .Point -0.075, -0.25, 0 
		' .Point -0.125, -0.3, 0 
		.Point -0.075, -0.3, 0 
		.Point -0.65, -0.3, 0 
		.Point -0.65, -0.5, 0 
		.Point -0.45, -0.70, 0 
		.Point 0.45, -0.70, 0 
		.Point 0.65, -0.5, 0 
		.Point 0.65, -0.3, 0 
		' .Point 0.125, -0.3, 0 
		' .Point 0.075, -0.25, 0 
		.Point 0.075, -0.3, 0 
		' .Point 0.075, 0.25, 0 
		' .Point 0.125, 0.3, 0
		.Point 0.075, 0.3, 0 
		.Point 1.25, 0.3, 0 
		.Create
	End With
	With Polygon3D
		.Reset
		.Name "lngs_profile"
		.Curve "magnet_curve"
		.Point 0, 0, 0
		.Point 0, 0, -1
		.Create
	End With

	With Polygon3D
		.Reset
		.Name "lngs_horn_cross_section"
		.Curve "magnet_curve"
		.Point 1.25, 0.3, 0
		.Point 1.25, 0.3, 0.65
		.Point 1, 0.3, 0.65
		.Point 0.65, 0.3, 0
		.Point 1.25, 0.3, 0
		.Create
	End With
	With Polygon3D
		.Reset
		.Name "lngs_horn_profile"
		.Curve "magnet_curve"
		.Point 1.25, 0.3, 0
		.Point 1.25, -0.3, 0
		.Create
	End With


	MakeSweepCurve("lngs_magnet", "magnet", LNGS_Magnet_Material, _
		"magnet_curve:lngs_cross_section", "magnet_curve:lngs_profile" _
	)

	MakeSweepCurve("lngs_magnet_horn", "magnet", LNGS_Magnet_Material, _
		"magnet_curve:lngs_horn_cross_section", "magnet_curve:lngs_horn_profile" _
	)

	With Transform 
		.Reset 
		.Name "magnet:lngs_magnet_horn" 
		.Origin "Free" 
		.Center "0", "0", "0" 
		.PlaneNormal "1", "0", "0" 
		.MultipleObjects "True" 
		.GroupObjects "False" 
		.Repetitions "1" 
		.MultipleSelection "False" 
		.Destination "" 
		.Material "" 
		.AutoDestination "True" 
		.Transform "Shape", "Mirror" 
	End With

	Solid.Add "magnet:lngs_magnet", "magnet:lngs_magnet_horn"
	Solid.Add "magnet:lngs_magnet", "magnet:lngs_magnet_horn_1"

	Pick.PickEdgeFromId "magnet:lngs_magnet", "30", "22"
	Pick.PickEdgeFromId "magnet:lngs_magnet", "29", "18"
	Pick.PickEdgeFromId "magnet:lngs_magnet", "26", "19"
	Pick.PickEdgeFromId "magnet:lngs_magnet", "51", "36"
	Pick.PickEdgeFromId "magnet:lngs_magnet", "53", "35"
	Pick.PickEdgeFromId "magnet:lngs_magnet", "54", "38"

	Solid.ChamferEdge "0.05", "45", "False", "23"


	With Polygon3D 
		.Reset 
		.Name "coil_cross_section" 
		.Curve "coil_curve" 
		.Point "0.36", "0", "0.065" 
		.Point "0.54", "0", "0.065" 
		.Point "0.54", "0", "0.069" 
		.Point "0.36", "0", "0.069" 
		.Point "0.36", "0", "0.065" 
		.Create 
	End With 

	With Polygon3D 
		.Reset 
		.Name "coil_path" 
		.Curve "coil_curve" 
		.Point "0.45", "0.452", "0.062" 
		.Point "0.45", "0.452", "-1.062" 
		.Point "0.45", "-0.452", "-1.062" 
		.Point "0.45", "-0.452", "0.062" 
		.Point "0.45", "0.452", "0.062" 
		.Create 
	End With

	Pick.PickCurveEndpointFromId "coil_curve:coil_path", "2"
	Pick.PickCurveEndpointFromId "coil_curve:coil_path", "1"
	Pick.PickCurveEndpointFromId "coil_curve:coil_path", "4"
	Pick.PickCurveEndpointFromId "coil_curve:coil_path", "3"

	With BlendCurve 
		.Reset 
		.Name "blend1" 
		.Radius "0.15" 
		.UsePickedPoints 
		.Create 
	End With
	With Coil
	     .Reset
	     .Name "coil1"
	     .Type "Coil"
	     .OperationMode "Current"
	     .ConductorModel "Stranded"
	     .ToolType "CurveCurve"
	     .Value 72000
	     .Phase "0.0"
	     .NTurns "1"
	     .Resistance "0.0"
	     .NStrands "120"
	     .StrandDiameter "0.05"
	     .LengthExtension "1.2"
	     .CurrentDirection "Inverted"
	     .ProjectProfileToPathAdvanced "True"
	     .ProfileName "coil_curve:coil_cross_section"
	     .PathName "coil_curve:coil_path"
	     .Create
	End With

	With Transform 
	     .Reset 
	     .Name "coil1" 
	     .Origin "Free" 
	     .Center "0", "0", "0" 
	     .PlaneNormal "1", "0", "0" 
	     .MultipleObjects "True" 
	     .GroupObjects "False" 
	     .Repetitions "1" 
	     .MultipleSelection "False" 
	     .Destination "" 
	     .Material "" 
	     .Transform "Coil", "Mirror" 
	End With
End Sub


''''''' Permanent Magnet Target

Sub Make_Permanent_Magnet_Target()

	MakeCylinderX( "perm_magnet_shape", "target", "Vacuum", _
		0.0, perm_magnet_radius, _
		perm_magnet_x-electrode_thickness, perm_magnet_x+electrode_thickness, _
		0, _
		perm_magnet_z _
	)

	With Magnet
		.Reset
		.Name "perm_magnet"
		.SetMagnetType "Constant"
		.Remanence perm_magnet_remnance
		.MagDir "1", "0", "0"
		.InverseDir "False"
		.Face "target:perm_magnet_shape", "2"
		.Transformable "True"
		.Create
	End With

	With Transform 
		.Reset 
		.Name "target:perm_magnet_shape" 
		.Origin "CommonCenter" 
		.Center "0", "0", "0" 
		.Angle "0", perm_magnet_rotation_deg, "0" 
		.MultipleObjects "False" 
		.GroupObjects "False" 
		.Repetitions "1" 
		.MultipleSelection "False" 
		.AutoDestination "True" 
		.Transform "Shape", "Rotate" 
	End With

End Sub
Sub Make_Target_Cylinder_Electrodes()

	MakeCylinderX( "pm_target", "target", "PEC", _
		0.0, perm_magnet_radius, _
		perm_magnet_x-electrode_thickness, perm_magnet_x+electrode_thickness, _
		0, _
		perm_magnet_z _
	)
	MakeCylinderX( "target_cylinder", "target", "PEC", _
		perm_magnet_radius+2*electrode_thickness, perm_magnet_radius+3*electrode_thickness, _
		perm_magnet_x-electrode_thickness, perm_magnet_x+target_cylinder_height, _
		0, _
		perm_magnet_z _
	)
	MakeCylinderX( "target_backscatter_catcher", "target", "PEC", _
		perm_magnet_radius+5*electrode_thickness, perm_magnet_radius+7*electrode_thickness, _
		perm_magnet_x-electrode_thickness, perm_magnet_x+electrode_thickness, _
		0, _
		perm_magnet_z _
	)
	MakeCylinderX( "target_backscatter_catcher_pcb", "target", "Epoxy resin", _
		0, perm_magnet_radius+8*electrode_thickness, _
		perm_magnet_x-2*electrode_thickness, perm_magnet_x+10*target_cylinder_height, _
		0, _
		perm_magnet_z _
	)
	MakeCylinderX( "target_backscatter_catcher_pcb_cutout", "target", "Epoxy resin", _
		0, perm_magnet_radius+7*electrode_thickness, _
		perm_magnet_x-electrode_thickness, perm_magnet_x+10*target_cylinder_height, _
		0, _
		perm_magnet_z _
	)
	MakePotential( "pm_base_pot", target_cylinder_voltage_inner,"target:pm_target", "2")
	MakePotential( "pm_inner_pot", target_cylinder_voltage_inner,"target:target_cylinder", "2")
	MakePotential( "pm_catcher_pot", target_backscatter_catcher_voltage,"target:target_backscatter_catcher", "2")

	RotateCommonCenterY("target:pm_target", perm_magnet_rotation_deg)
	RotateFreeCenterY("target:target_cylinder", perm_magnet_rotation_deg, perm_magnet_x, 0, perm_magnet_z)
	RotateFreeCenterY("target:target_backscatter_catcher", perm_magnet_rotation_deg, perm_magnet_x, 0, perm_magnet_z)
	RotateFreeCenterY("target:target_backscatter_catcher_pcb", perm_magnet_rotation_deg, perm_magnet_x, 0, perm_magnet_z)
	RotateFreeCenterY("target:target_backscatter_catcher_pcb_cutout", perm_magnet_rotation_deg, perm_magnet_x, 0, perm_magnet_z)
	Solid.Subtract "target:target_backscatter_catcher_pcb", "target:target_backscatter_catcher_pcb_cutout"


End Sub

''''''' Parallel Drain Electrodes (generated from LNGS_target.ipynb)

Sub Make_Parallel_Drain_Electrodes()
	With Polygon3D
		.Reset
		.Name "pd_16_29_outline"
		.Curve "paradrain_curve"
		.Point -0.198, filter_dimension_half_y_stage_1, -1.302-0.057  
		.Point -0.265, filter_dimension_half_y_stage_1, -1.302-0.076  
		.Point -0.238, filter_dimension_half_y_stage_1, -1.302-0.132  
		.Point -0.177, filter_dimension_half_y_stage_1, -1.302-0.098  
		.Point -0.198, filter_dimension_half_y_stage_1, -1.302-0.057  
		.Create
	End With
	With Polygon3D
		.Reset
		.Name "pd_16_29_profile"
		.Curve "paradrain_curve"
		.Point -0.198, filter_dimension_half_y_stage_1, -1.302-0.057  
		.Point -0.198, filter_dimension_half_y_stage_1+electrode_thickness, -1.302-0.057  
		.Create
	End With
	MakeSweepCurve("pd_16_29", "paradrain_electrodes", "PEC", _
		"paradrain_curve:pd_16_29_outline", "paradrain_curve:pd_16_29_profile" _
	)
	MirrorCopyY("paradrain_electrodes:pd_16_29")
	MakeBrick("pd_cutout", "paradrain_electrodes", "Vacuum", -filter_dimension_half_x, filter_dimension_half_x, -(filter_dimension_half_y_stage_1+electrode_thickness), (filter_dimension_half_y_stage_1+electrode_thickness), -1.302-0.5, -1.302)
	Solid.Subtract "paradrain_electrodes:pd_16_29", "paradrain_electrodes:pd_cutout"
	MakeBrick("pd_cutout", "paradrain_electrodes", "Vacuum", -filter_dimension_half_x, filter_dimension_half_x, -(filter_dimension_half_y_stage_1+electrode_thickness), (filter_dimension_half_y_stage_1+electrode_thickness), -1.302-0.5, -1.302)
	Solid.Subtract "paradrain_electrodes:pd_16_29_1", "paradrain_electrodes:pd_cutout"
	MakePotential( "pd_16_29", 15000, _
		"paradrain_electrodes:pd_16_29", "11" _
	)
	MakePotential( "pd_16_29_1", 15000, _
		"paradrain_electrodes:pd_16_29_1", "11" _
	)
	With Polygon3D
		.Reset
		.Name "pd_31_44_outline"
		.Curve "paradrain_curve"
		.Point -0.173, filter_dimension_half_y_stage_1, -1.302-0.104  
		.Point -0.233, filter_dimension_half_y_stage_1, -1.302-0.140  
		.Point -0.191, filter_dimension_half_y_stage_1, -1.302-0.185  
		.Point -0.141, filter_dimension_half_y_stage_1, -1.302-0.136  
		.Point -0.173, filter_dimension_half_y_stage_1, -1.302-0.104  
		.Create
	End With
	With Polygon3D
		.Reset
		.Name "pd_31_44_profile"
		.Curve "paradrain_curve"
		.Point -0.173, filter_dimension_half_y_stage_1, -1.302-0.104  
		.Point -0.173, filter_dimension_half_y_stage_1+electrode_thickness, -1.302-0.104  
		.Create
	End With
	MakeSweepCurve("pd_31_44", "paradrain_electrodes", "PEC", _
		"paradrain_curve:pd_31_44_outline", "paradrain_curve:pd_31_44_profile" _
	)
	MirrorCopyY("paradrain_electrodes:pd_31_44")
	MakeBrick("pd_cutout", "paradrain_electrodes", "Vacuum", -filter_dimension_half_x, filter_dimension_half_x, -(filter_dimension_half_y_stage_1+electrode_thickness), (filter_dimension_half_y_stage_1+electrode_thickness), -1.302-0.5, -1.302)
	Solid.Subtract "paradrain_electrodes:pd_31_44", "paradrain_electrodes:pd_cutout"
	MakeBrick("pd_cutout", "paradrain_electrodes", "Vacuum", -filter_dimension_half_x, filter_dimension_half_x, -(filter_dimension_half_y_stage_1+electrode_thickness), (filter_dimension_half_y_stage_1+electrode_thickness), -1.302-0.5, -1.302)
	Solid.Subtract "paradrain_electrodes:pd_31_44_1", "paradrain_electrodes:pd_cutout"
	MakePotential( "pd_31_44", 12000, _
		"paradrain_electrodes:pd_31_44", "11" _
	)
	MakePotential( "pd_31_44_1", 12000, _
		"paradrain_electrodes:pd_31_44_1", "11" _
	)
	With Polygon3D
		.Reset
		.Name "pd_46_59_outline"
		.Curve "paradrain_curve"
		.Point -0.136, filter_dimension_half_y_stage_1, -1.302-0.140  
		.Point -0.184, filter_dimension_half_y_stage_1, -1.302-0.191  
		.Point -0.134, filter_dimension_half_y_stage_1, -1.302-0.223  
		.Point -0.098, filter_dimension_half_y_stage_1, -1.302-0.163  
		.Point -0.136, filter_dimension_half_y_stage_1, -1.302-0.140  
		.Create
	End With
	With Polygon3D
		.Reset
		.Name "pd_46_59_profile"
		.Curve "paradrain_curve"
		.Point -0.136, filter_dimension_half_y_stage_1, -1.302-0.140  
		.Point -0.136, filter_dimension_half_y_stage_1+electrode_thickness, -1.302-0.140  
		.Create
	End With
	MakeSweepCurve("pd_46_59", "paradrain_electrodes", "PEC", _
		"paradrain_curve:pd_46_59_outline", "paradrain_curve:pd_46_59_profile" _
	)
	MirrorCopyY("paradrain_electrodes:pd_46_59")
	MakeBrick("pd_cutout", "paradrain_electrodes", "Vacuum", -filter_dimension_half_x, filter_dimension_half_x, -(filter_dimension_half_y_stage_1+electrode_thickness), (filter_dimension_half_y_stage_1+electrode_thickness), -1.302-0.5, -1.302)
	Solid.Subtract "paradrain_electrodes:pd_46_59", "paradrain_electrodes:pd_cutout"
	MakeBrick("pd_cutout", "paradrain_electrodes", "Vacuum", -filter_dimension_half_x, filter_dimension_half_x, -(filter_dimension_half_y_stage_1+electrode_thickness), (filter_dimension_half_y_stage_1+electrode_thickness), -1.302-0.5, -1.302)
	Solid.Subtract "paradrain_electrodes:pd_46_59_1", "paradrain_electrodes:pd_cutout"
	MakePotential( "pd_46_59", 8000, _
		"paradrain_electrodes:pd_46_59", "11" _
	)
	MakePotential( "pd_46_59_1", 8000, _
		"paradrain_electrodes:pd_46_59_1", "11" _
	)
	With Polygon3D
		.Reset
		.Name "pd_61_89_outline"
		.Curve "paradrain_curve"
		.Point -0.092, filter_dimension_half_y_stage_1, -1.302-0.166  
		.Point -0.126, filter_dimension_half_y_stage_1, -1.302-0.227  
		.Point -0.004, filter_dimension_half_y_stage_1, -1.302-0.255  
		.Point -0.003, filter_dimension_half_y_stage_1, -1.302-0.185  
		.Point -0.092, filter_dimension_half_y_stage_1, -1.302-0.166  
		.Create
	End With
	With Polygon3D
		.Reset
		.Name "pd_61_89_profile"
		.Curve "paradrain_curve"
		.Point -0.092, filter_dimension_half_y_stage_1, -1.302-0.166  
		.Point -0.092, filter_dimension_half_y_stage_1+electrode_thickness, -1.302-0.166  
		.Create
	End With
	MakeSweepCurve("pd_61_89", "paradrain_electrodes", "PEC", _
		"paradrain_curve:pd_61_89_outline", "paradrain_curve:pd_61_89_profile" _
	)
	MirrorCopyY("paradrain_electrodes:pd_61_89")
	MakeBrick("pd_cutout", "paradrain_electrodes", "Vacuum", -filter_dimension_half_x, filter_dimension_half_x, -(filter_dimension_half_y_stage_1+electrode_thickness), (filter_dimension_half_y_stage_1+electrode_thickness), -1.302-0.5, -1.302)
	Solid.Subtract "paradrain_electrodes:pd_61_89", "paradrain_electrodes:pd_cutout"
	MakeBrick("pd_cutout", "paradrain_electrodes", "Vacuum", -filter_dimension_half_x, filter_dimension_half_x, -(filter_dimension_half_y_stage_1+electrode_thickness), (filter_dimension_half_y_stage_1+electrode_thickness), -1.302-0.5, -1.302)
	Solid.Subtract "paradrain_electrodes:pd_61_89_1", "paradrain_electrodes:pd_cutout"
	MakePotential( "pd_61_89", 5000, _
		"paradrain_electrodes:pd_61_89", "11" _
	)
	MakePotential( "pd_61_89_1", 5000, _
		"paradrain_electrodes:pd_61_89_1", "11" _
	)
End Sub

''''''' Injection Electrodes
Sub Make_Injection_Electrodes()

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''bounce

	MakeBrick("pd_top", "paradrain_electrodes", "PEC", (filter_dimension_half_x-electrode_thickness), (filter_dimension_half_x-electrode_thickness), -(filter_dimension_half_y_stage_1-electrode_thickness), (filter_dimension_half_y_stage_1-electrode_thickness), _
		injection_electrode_z_start, injection_electrode_z_end)
	MakePotential( "pd_bounce_top", injection_bounce_voltage, "paradrain_electrodes:pd_top", "4")

	MakeBrick("pd_bot", "paradrain_electrodes", "PEC", -(filter_dimension_half_x-electrode_thickness), -(filter_dimension_half_x-electrode_thickness), -(filter_dimension_half_y_stage_1-electrode_thickness), (filter_dimension_half_y_stage_1-electrode_thickness), _
		injection_electrode_z_start+0.06, injection_electrode_z_end)
	MakePotential( "pd_bounce_bot", injection_bounce_voltage, "paradrain_electrodes:pd_bot", "4")

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''5
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+4*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+5*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	MakeBrick("pd_drift5", "paradrain_electrodes", "PEC", x1, x2, (filter_dimension_half_y_stage_1+electrode_thickness), (filter_dimension_half_y_stage_1+electrode_thickness), injection_electrode_z_start, injection_electrode_z_end)
	MirrorCopyY("paradrain_electrodes:pd_drift5")

	MakePotential( "pd_drift5_1", injection_potential_5-injection_half_drift_voltage_5, "paradrain_electrodes:pd_drift5_1", "3")
	MakePotential( "pd_drift5", injection_potential_5+injection_half_drift_voltage_5, "paradrain_electrodes:pd_drift5", "3")

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''4
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+3*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+4*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	MakeBrick("pd_drift4", "paradrain_electrodes", "PEC", x1, x2, (filter_dimension_half_y_stage_1+electrode_thickness), (filter_dimension_half_y_stage_1+electrode_thickness), injection_electrode_z_start, injection_electrode_z_end)
	MirrorCopyY("paradrain_electrodes:pd_drift4")

	MakePotential( "pd_drift4_1", injection_potential_4-injection_half_drift_voltage_4, "paradrain_electrodes:pd_drift4_1", "3")
	MakePotential( "pd_drift4", injection_potential_4+injection_half_drift_voltage_4, "paradrain_electrodes:pd_drift4", "3")

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''3
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+2*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+3*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	MakeBrick("pd_drift3", "paradrain_electrodes", "PEC", x1, x2, (filter_dimension_half_y_stage_1+electrode_thickness), (filter_dimension_half_y_stage_1+electrode_thickness), injection_electrode_z_start, injection_electrode_z_end)
	MirrorCopyY("paradrain_electrodes:pd_drift3")

	MakePotential( "pd_drift3_1", injection_potential_3-injection_half_drift_voltage_3, "paradrain_electrodes:pd_drift3_1", "3")
	MakePotential( "pd_drift3", injection_potential_3+injection_half_drift_voltage_3, "paradrain_electrodes:pd_drift3", "3")

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''2
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+1*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+2*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	MakeBrick("pd_drift2", "paradrain_electrodes", "PEC", x1, x2, (filter_dimension_half_y_stage_1+electrode_thickness), (filter_dimension_half_y_stage_1+electrode_thickness), injection_electrode_z_start, injection_electrode_z_end)
	MirrorCopyY("paradrain_electrodes:pd_drift2")

	MakePotential( "pd_drift2_1", injection_potential_2-injection_half_drift_voltage_2, "paradrain_electrodes:pd_drift2_1", "3")
	MakePotential( "pd_drift2", injection_potential_2+injection_half_drift_voltage_2, "paradrain_electrodes:pd_drift2", "3")

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''1
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+0*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+1*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	MakeBrick("pd_drift1", "paradrain_electrodes", "PEC", x1, x2, (filter_dimension_half_y_stage_1+electrode_thickness), (filter_dimension_half_y_stage_1+electrode_thickness), injection_electrode_z_start, injection_electrode_z_end)
	MirrorCopyY("paradrain_electrodes:pd_drift1")

	MakePotential( "pd_drift1_1", injection_potential_1-injection_half_drift_voltage_1, "paradrain_electrodes:pd_drift1_1", "3")
	MakePotential( "pd_drift1", injection_potential_1+injection_half_drift_voltage_1, "paradrain_electrodes:pd_drift1", "3")

End Sub
''''''' Filter PCBs

Sub Make_Filter_Stage_1_PCBs()

	'''' PCBs ''''

	MakeBrick("b_top_pcb", "bounce_electrodes", "Epoxy resin", _
		(filter_dimension_half_x-electrode_thickness), filter_dimension_half_x, _
		-filter_dimension_half_y_stage_1, filter_dimension_half_y_stage_1, _
		injection_electrode_z_start, bounce_electrodes_z_end_stage_1 _
	)

	MakeBrick("b_bot_pcb", "bounce_electrodes", "Epoxy resin", _
		-(filter_dimension_half_x-electrode_thickness), -filter_dimension_half_x, _
		-filter_dimension_half_y_stage_1, filter_dimension_half_y_stage_1, _
		injection_electrode_z_start+0.06, bounce_electrodes_z_end_stage_1 _
	)

	MakeBrick("fe_negy_pcb", "filter_electrodes", "Epoxy resin", _
		-(filter_dimension_half_x-electrode_thickness), (filter_dimension_half_x-electrode_thickness), _
		-(filter_dimension_half_y_stage_1+electrode_thickness), -filter_dimension_half_y_stage_1, _
		injection_electrode_z_start, filter_electrodes_z_end_stage_1 _
	)

	MakeBrick("fe_posy_pcb", "filter_electrodes", "Epoxy resin", _
		-(filter_dimension_half_x-electrode_thickness), (filter_dimension_half_x-electrode_thickness), _
		(filter_dimension_half_y_stage_1+electrode_thickness), filter_dimension_half_y_stage_1, _
		injection_electrode_z_start, filter_electrodes_z_end_stage_1 _
	)

	' MakeBrick("injectback_pcb", "paradrain_electrodes", "Epoxy resin", _
	' 	filter_dimension_half_x, -filter_dimension_half_x, _
	' 	-filter_dimension_half_y_stage_1, filter_dimension_half_y_stage_1, _
	' 	injection_electrode_z_start, injection_electrode_z_start-electrode_thickness _
	' )

End Sub
Sub Make_Filter_Stage_2_PCBs()

	'''' PCBs ''''
	MakeBrick("b_top_pcb_2nd", "bounce_electrodes_2nd", "Epoxy resin", _
		(filter_dimension_half_x-electrode_thickness), filter_dimension_half_x, _
		-filter_dimension_half_y_stage_2, filter_dimension_half_y_stage_2, _
		bounce_electrodes_z_start_stage_2, bounce_electrodes_z_end_stage_2 _
	)

	MakeBrick("b_bot_pcb_2nd", "bounce_electrodes_2nd", "Epoxy resin", _
		-(filter_dimension_half_x-electrode_thickness), -filter_dimension_half_x, _
		-filter_dimension_half_y_stage_2, filter_dimension_half_y_stage_2, _
		bounce_electrodes_z_start_stage_2, bounce_electrodes_z_end_stage_2 _
	)

	MakeBrick("fe_negy_pcb_2nd", "filter_electrodes_2nd", "Epoxy resin", _
		-(filter_dimension_half_x-electrode_thickness), (filter_dimension_half_x-electrode_thickness), _
		-(filter_dimension_half_y_stage_2+electrode_thickness), -filter_dimension_half_y_stage_2, _
		filter_electrodes_z_start_stage_2, filter_electrodes_z_end_stage_2 _
	)

	MakeBrick("fe_posy_pcb_2nd", "filter_electrodes_2nd", "Epoxy resin", _
		-(filter_dimension_half_x-electrode_thickness), (filter_dimension_half_x-electrode_thickness), _
		(filter_dimension_half_y_stage_2+electrode_thickness), filter_dimension_half_y_stage_2, _
		filter_electrodes_z_start_stage_2, filter_electrodes_z_end_stage_2 _
	)

End Sub
Sub Make_Filter_Stage_3_PCBs()

	'''' PCBs ''''
	MakeBrick("b_top_pcb_3rd", "bounce_electrodes_3rd", "Epoxy resin", _
		(filter_dimension_half_x-electrode_thickness), filter_dimension_half_x, _
		-filter_dimension_half_y_stage_3, filter_dimension_half_y_stage_3, _
		bounce_electrodes_z_start_stage_3, bounce_electrodes_z_end_stage_3 _
	)

	MakeBrick("b_bot_pcb_3rd", "bounce_electrodes_3rd", "Epoxy resin", _
		-(filter_dimension_half_x-electrode_thickness), -filter_dimension_half_x, _
		-filter_dimension_half_y_stage_3, filter_dimension_half_y_stage_3, _
		bounce_electrodes_z_start_stage_3, bounce_electrodes_z_end_stage_3 _
	)

	MakeBrick("fe_negy_pcb_3rd", "filter_electrodes_3rd", "Epoxy resin", _
		-(filter_dimension_half_x-electrode_thickness), (filter_dimension_half_x-electrode_thickness), _
		-(filter_dimension_half_y_stage_3+electrode_thickness), -filter_dimension_half_y_stage_3, _
		filter_electrodes_z_start_stage_3, filter_electrodes_z_end_stage_3 _
	)

	MakeBrick("fe_posy_pcb_3rd", "filter_electrodes_3rd", "Epoxy resin", _
		-(filter_dimension_half_x-electrode_thickness), (filter_dimension_half_x-electrode_thickness), _
		(filter_dimension_half_y_stage_3+electrode_thickness), filter_dimension_half_y_stage_3, _
		filter_electrodes_z_start_stage_3, filter_electrodes_z_end_stage_3 _
	)

End Sub
Sub Make_Filter_Stage_4_PCBs()

	'''' PCBs ''''
	MakeBrick("b_top_pcb_4th", "bounce_electrodes_4th", "Epoxy resin", _
		(filter_dimension_half_x-electrode_thickness), filter_dimension_half_x, _
		-filter_dimension_half_y_stage_4, filter_dimension_half_y_stage_4, _
		bounce_electrodes_z_start_stage_4, bounce_electrodes_z_end_stage_4 _
	)

	MakeBrick("b_bot_pcb_4th", "bounce_electrodes_4th", "Epoxy resin", _
		-(filter_dimension_half_x-electrode_thickness), -filter_dimension_half_x, _
		-filter_dimension_half_y_stage_4, filter_dimension_half_y_stage_4, _
		bounce_electrodes_z_start_stage_4, bounce_electrodes_z_end_stage_4 _
	)

	MakeBrick("fe_negy_pcb_4th", "filter_electrodes_4th", "Epoxy resin", _
		-(filter_dimension_half_x-electrode_thickness), (filter_dimension_half_x-electrode_thickness), _
		-(filter_dimension_half_y_stage_4+electrode_thickness), -filter_dimension_half_y_stage_4, _
		filter_electrodes_z_start_stage_4, filter_electrodes_z_end_stage_4 _
	)

	MakeBrick("fe_posy_pcb_4th", "filter_electrodes_4th", "Epoxy resin", _
		-(filter_dimension_half_x-electrode_thickness), (filter_dimension_half_x-electrode_thickness), _
		(filter_dimension_half_y_stage_4+electrode_thickness), filter_dimension_half_y_stage_4, _
		filter_electrodes_z_start_stage_4, filter_electrodes_z_end_stage_4 _
	)

End Sub
Sub Make_Filter_Stage_5_PCBs()

	'''' PCBs ''''
	MakeBrick("b_top_pcb_5th", "bounce_electrodes_5th", "Epoxy resin", _
		(filter_dimension_half_x-electrode_thickness), filter_dimension_half_x, _
		-filter_dimension_half_y_stage_5, filter_dimension_half_y_stage_5, _
		bounce_electrodes_z_start_stage_5, bounce_electrodes_z_end_stage_5 _
	)

	MakeBrick("b_bot_pcb_5th", "bounce_electrodes_5th", "Epoxy resin", _
		-(filter_dimension_half_x-electrode_thickness), -filter_dimension_half_x, _
		-filter_dimension_half_y_stage_5, filter_dimension_half_y_stage_5, _
		bounce_electrodes_z_start_stage_5, bounce_electrodes_z_end_stage_5 _
	)

	MakeBrick("fe_negy_pcb_5th", "filter_electrodes_5th", "Epoxy resin", _
		-(filter_dimension_half_x-electrode_thickness), (filter_dimension_half_x-electrode_thickness), _
		-(filter_dimension_half_y_stage_5+electrode_thickness), -filter_dimension_half_y_stage_5, _
		filter_electrodes_z_start_stage_5, filter_electrodes_z_end_stage_5 _
	)

	MakeBrick("fe_posy_pcb_5th", "filter_electrodes_5th", "Epoxy resin", _
		-(filter_dimension_half_x-electrode_thickness), (filter_dimension_half_x-electrode_thickness), _
		(filter_dimension_half_y_stage_5+electrode_thickness), filter_dimension_half_y_stage_5, _
		filter_electrodes_z_start_stage_5, filter_electrodes_z_end_stage_5 _
	)

End Sub

''''''' Filter Electrodes

Sub Make_Filter_Stage_1_Electrodes()

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''bounce

	For z = 0 To n_electrodes_filter_stage_1_end-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		MakeBrick("b_top_"&z, "bounce_electrodes", "PEC", (filter_dimension_half_x-electrode_thickness), (filter_dimension_half_x-electrode_thickness), -(filter_dimension_half_y_stage_1-electrode_thickness), (filter_dimension_half_y_stage_1-electrode_thickness), _
			zstart, zstart+electrode_length_z)
		MakeBrick("b_bot_"&z, "bounce_electrodes", "PEC", -(filter_dimension_half_x-electrode_thickness), -(filter_dimension_half_x-electrode_thickness), -(filter_dimension_half_y_stage_1-electrode_thickness), (filter_dimension_half_y_stage_1-electrode_thickness), _
			zstart, zstart+electrode_length_z)

		
		If z<n_electrodes_accel_region_end Then
			bv_top = injection_bounce_voltage
			bv_bot = injection_bounce_voltage
		Else
			bv_top = injection_bounce_voltage*Sqr(Bx_Normalized(z))
			bv_bot = injection_bounce_voltage*Sqr(Bx_Normalized(z))
		End If

		MakePotential( "b_top_"&z, bv_top, "bounce_electrodes:b_top_"&z, "4")
		MakePotential( "b_bot_"&z, bv_bot, "bounce_electrodes:b_bot_"&z, "4")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''5
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+4*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+5*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = 0 To (n_electrodes_filter_stage_1_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_negy = (injection_potential_5-injection_half_drift_voltage_5)+ ( (negy5t-offset*vscale5*Bx_Normalized(z))-(injection_potential_5-injection_half_drift_voltage_5) )*(z/n_electrodes_accel_region_end)
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
		
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_negy = negy5t -offset*vscale5*Bx_Normalized(z)
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
		
		Else
			accel_negy = negy5t -offset*vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch5_"&z, "filter_electrodes", "PEC", x1, x2, (filter_dimension_half_y_stage_1+electrode_thickness), (filter_dimension_half_y_stage_1+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes:fe_ch5_"&z)
		MakePotential( "fe_ch5_"&CStr(z)&"_1", accel_negy, "filter_electrodes:fe_ch5_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch5_"&z, accel_posy, "filter_electrodes:fe_ch5_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''4
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+3*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+4*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = 0 To (n_electrodes_filter_stage_1_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_4-injection_half_drift_voltage_4)+ ( (negy4t-offset*vscale4*Bx_Normalized(z))-(injection_potential_4-injection_half_drift_voltage_4) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Normalized(z)
		Else
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch4_"&z, "filter_electrodes", "PEC", x1, x2, (filter_dimension_half_y_stage_1+electrode_thickness), (filter_dimension_half_y_stage_1+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes:fe_ch4_"&z)
		MakePotential( "fe_ch4_"&CStr(z)&"_1", accel_negy, "filter_electrodes:fe_ch4_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch4_"&z, accel_posy, "filter_electrodes:fe_ch4_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''3
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+2*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+3*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = 0 To (n_electrodes_filter_stage_1_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale3*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_3-injection_half_drift_voltage_3)+ ( (negy3t-offset*vscale3*Bx_Normalized(z))-(injection_potential_3-injection_half_drift_voltage_3) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale3*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy3t -offset*vscale3*Bx_Normalized(z)
		Else
			accel_posy = vscale3*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy3t -offset*vscale3*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch3_"&z, "filter_electrodes", "PEC", x1, x2, (filter_dimension_half_y_stage_1+electrode_thickness), (filter_dimension_half_y_stage_1+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes:fe_ch3_"&z)
		MakePotential( "fe_ch3_"&CStr(z)&"_1", accel_negy,	"filter_electrodes:fe_ch3_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch3_"&z, accel_posy, "filter_electrodes:fe_ch3_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''2
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+1*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+2*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = 0 To (n_electrodes_filter_stage_1_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_4-injection_half_drift_voltage_4)+ ( (negy4t-offset*vscale4*Bx_Normalized(z))-(injection_potential_4-injection_half_drift_voltage_4) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Normalized(z)
		Else
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch2_"&z, "filter_electrodes", "PEC", x1, x2, (filter_dimension_half_y_stage_1+electrode_thickness), (filter_dimension_half_y_stage_1+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes:fe_ch2_"&z)
		MakePotential( "fe_ch2_"&CStr(z)&"_1", accel_negy, "filter_electrodes:fe_ch2_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch2_"&z, accel_posy, "filter_electrodes:fe_ch2_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''1
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+0*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+1*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = 0 To (n_electrodes_filter_stage_1_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_5-injection_half_drift_voltage_5)+ ( (negy5t-offset*vscale5*Bx_Normalized(z))-(injection_potential_5-injection_half_drift_voltage_5) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy5t -offset*vscale5*Bx_Normalized(z)
		Else
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy5t -offset*vscale5*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch1_"&z, "filter_electrodes", "PEC", x1, x2, (filter_dimension_half_y_stage_1+electrode_thickness), (filter_dimension_half_y_stage_1+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes:fe_ch1_"&z)
		MakePotential( "fe_ch1_"&CStr(z)&"_1", accel_negy, "filter_electrodes:fe_ch1_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch1_"&z, accel_posy, "filter_electrodes:fe_ch1_"&z, "3")
	Next


End Sub
Sub Make_Filter_Stage_2_Electrodes()

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''bounce

	For z = n_electrodes_filter_stage_1_end To n_electrodes_filter_stage_2_end-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		MakeBrick("b_top_2nd_"&z, "bounce_electrodes_2nd", "PEC", (filter_dimension_half_x-electrode_thickness), (filter_dimension_half_x-electrode_thickness), -(filter_dimension_half_y_stage_2-electrode_thickness), (filter_dimension_half_y_stage_2-electrode_thickness), _
			zstart, zstart+electrode_length_z)
		MakeBrick("b_bot_2nd_"&z, "bounce_electrodes_2nd", "PEC", -(filter_dimension_half_x-electrode_thickness), -(filter_dimension_half_x-electrode_thickness), -(filter_dimension_half_y_stage_2-electrode_thickness), (filter_dimension_half_y_stage_2-electrode_thickness), _
			zstart, zstart+electrode_length_z)

		If z<n_electrodes_accel_region_end Then
			bv_top = injection_bounce_voltage
			bv_bot = injection_bounce_voltage
		Else
			bv_top = injection_bounce_voltage*Sqr(Bx_Normalized(z))
			bv_bot = injection_bounce_voltage*Sqr(Bx_Normalized(z))
		End If

		MakePotential( "b_top_2nd_"&z, bv_top, "bounce_electrodes_2nd:b_top_2nd_"&z, "4")
		MakePotential( "b_bot_2nd_"&z, bv_bot, "bounce_electrodes_2nd:b_bot_2nd_"&z, "4")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''5
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+4*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+5*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_1_end To (n_electrodes_filter_stage_2_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_5-injection_half_drift_voltage_5)+ ( (negy5t-offset*vscale5*Bx_Normalized(z))-(injection_potential_5-injection_half_drift_voltage_5) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy5t -offset*vscale5*Bx_Normalized(z)
		Else
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy5t -offset*vscale5*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch5_2nd_"&z, "filter_electrodes_2nd", "PEC", x1, x2, (filter_dimension_half_y_stage_2+electrode_thickness), (filter_dimension_half_y_stage_2+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_2nd:fe_ch5_2nd_"&z)
		MakePotential( "fe_ch5_2nd_"&CStr(z)&"_1", accel_negy, "filter_electrodes_2nd:fe_ch5_2nd_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch5_2nd_"&z, accel_posy, "filter_electrodes_2nd:fe_ch5_2nd_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''4
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+3*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+4*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_1_end To (n_electrodes_filter_stage_2_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_4-injection_half_drift_voltage_4)+ ( (negy4t-offset*vscale4*Bx_Normalized(z))-(injection_potential_4-injection_half_drift_voltage_4) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Normalized(z)
		Else
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch4_2nd_"&z, "filter_electrodes_2nd", "PEC", x1, x2, (filter_dimension_half_y_stage_2+electrode_thickness), (filter_dimension_half_y_stage_2+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_2nd:fe_ch4_2nd_"&z)
		MakePotential( "fe_ch4_2nd_"&CStr(z)&"_1", accel_negy, "filter_electrodes_2nd:fe_ch4_2nd_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch4_2nd_"&z, accel_posy, "filter_electrodes_2nd:fe_ch4_2nd_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''3
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+2*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+3*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_1_end To (n_electrodes_filter_stage_2_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale3*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_3-injection_half_drift_voltage_3)+ ( (negy3t-offset*vscale3*Bx_Normalized(z))-(injection_potential_3-injection_half_drift_voltage_3) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale3*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy3t -offset*vscale3*Bx_Normalized(z)
		Else
			accel_posy = vscale3*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy3t -offset*vscale3*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch3_2nd_"&z, "filter_electrodes_2nd", "PEC", x1, x2, (filter_dimension_half_y_stage_2+electrode_thickness), (filter_dimension_half_y_stage_2+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_2nd:fe_ch3_2nd_"&z)
		MakePotential( "fe_ch3_2nd_"&CStr(z)&"_1", accel_negy,	"filter_electrodes_2nd:fe_ch3_2nd_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch3_2nd_"&z, accel_posy, "filter_electrodes_2nd:fe_ch3_2nd_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''2
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+1*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+2*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_1_end To (n_electrodes_filter_stage_2_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_4-injection_half_drift_voltage_4)+ ( (negy4t-offset*vscale4*Bx_Normalized(z))-(injection_potential_4-injection_half_drift_voltage_4) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Normalized(z)
		Else
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch2_2nd_"&z, "filter_electrodes_2nd", "PEC", x1, x2, (filter_dimension_half_y_stage_2+electrode_thickness), (filter_dimension_half_y_stage_2+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_2nd:fe_ch2_2nd_"&z)
		MakePotential( "fe_ch2_2nd_"&CStr(z)&"_1", accel_negy, "filter_electrodes_2nd:fe_ch2_2nd_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch2_2nd_"&z, accel_posy, "filter_electrodes_2nd:fe_ch2_2nd_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''1
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+0*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+1*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_1_end To (n_electrodes_filter_stage_2_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_5-injection_half_drift_voltage_5)+ ( (negy5t-offset*vscale5*Bx_Normalized(z))-(injection_potential_5-injection_half_drift_voltage_5) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy5t -offset*vscale5*Bx_Normalized(z)
		Else
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy5t -offset*vscale5*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch1_2nd_"&z, "filter_electrodes_2nd", "PEC", x1, x2, (filter_dimension_half_y_stage_2+electrode_thickness), (filter_dimension_half_y_stage_2+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_2nd:fe_ch1_2nd_"&z)
		MakePotential( "fe_ch1_2nd_"&CStr(z)&"_1", accel_negy, "filter_electrodes_2nd:fe_ch1_2nd_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch1_2nd_"&z, accel_posy, "filter_electrodes_2nd:fe_ch1_2nd_"&z, "3")
	Next

End Sub
Sub Make_Filter_Stage_3_Electrodes()

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''bounce

	For z = n_electrodes_filter_stage_2_end To n_electrodes_filter_stage_3_end-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		MakeBrick("b_top_3rd_"&z, "bounce_electrodes_3rd", "PEC", (filter_dimension_half_x-electrode_thickness), (filter_dimension_half_x-electrode_thickness), -(filter_dimension_half_y_stage_3-electrode_thickness), (filter_dimension_half_y_stage_3-electrode_thickness), _
			zstart, zstart+electrode_length_z)
		MakeBrick("b_bot_3rd_"&z, "bounce_electrodes_3rd", "PEC", -(filter_dimension_half_x-electrode_thickness), -(filter_dimension_half_x-electrode_thickness), -(filter_dimension_half_y_stage_3-electrode_thickness), (filter_dimension_half_y_stage_3-electrode_thickness), _
			zstart, zstart+electrode_length_z)

		If z<n_electrodes_accel_region_end Then
			bv_top = injection_bounce_voltage
			bv_bot = injection_bounce_voltage
		Else
			bv_top = injection_bounce_voltage*Sqr(Bx_Normalized(z))
			bv_bot = injection_bounce_voltage*Sqr(Bx_Normalized(z))
		End If

		MakePotential( "b_top_3rd_"&z, bv_top, "bounce_electrodes_3rd:b_top_3rd_"&z, "4")
		MakePotential( "b_bot_3rd_"&z, bv_bot, "bounce_electrodes_3rd:b_bot_3rd_"&z, "4")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''5
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+4*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+5*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_2_end To (n_electrodes_filter_stage_3_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_5-injection_half_drift_voltage_5)+ ( (negy5t-offset*vscale5*Bx_Normalized(z))-(injection_potential_5-injection_half_drift_voltage_5) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy5t -offset*vscale5*Bx_Normalized(z)
		Else
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy5t -offset*vscale5*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch5_3rd_"&z, "filter_electrodes_3rd", "PEC", x1, x2, (filter_dimension_half_y_stage_3+electrode_thickness), (filter_dimension_half_y_stage_3+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_3rd:fe_ch5_3rd_"&z)
		MakePotential( "fe_ch5_3rd_"&CStr(z)&"_1", accel_negy, "filter_electrodes_3rd:fe_ch5_3rd_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch5_3rd_"&z, accel_posy, "filter_electrodes_3rd:fe_ch5_3rd_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''4
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+3*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+4*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_2_end To (n_electrodes_filter_stage_3_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_4-injection_half_drift_voltage_4)+ ( (negy4t-offset*vscale4*Bx_Normalized(z))-(injection_potential_4-injection_half_drift_voltage_4) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Normalized(z)
		Else
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch4_3rd_"&z, "filter_electrodes_3rd", "PEC", x1, x2, (filter_dimension_half_y_stage_3+electrode_thickness), (filter_dimension_half_y_stage_3+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_3rd:fe_ch4_3rd_"&z)
		MakePotential( "fe_ch4_3rd_"&CStr(z)&"_1", accel_negy, "filter_electrodes_3rd:fe_ch4_3rd_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch4_3rd_"&z, accel_posy, "filter_electrodes_3rd:fe_ch4_3rd_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''3
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+2*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+3*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_2_end To (n_electrodes_filter_stage_3_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale3*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_3-injection_half_drift_voltage_3)+ ( (negy3t-offset*vscale3*Bx_Normalized(z))-(injection_potential_3-injection_half_drift_voltage_3) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale3*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy3t -offset*vscale3*Bx_Normalized(z)
		Else
			accel_posy = vscale3*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy3t -offset*vscale3*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch3_3rd_"&z, "filter_electrodes_3rd", "PEC", x1, x2, (filter_dimension_half_y_stage_3+electrode_thickness), (filter_dimension_half_y_stage_3+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_3rd:fe_ch3_3rd_"&z)
		MakePotential( "fe_ch3_3rd_"&CStr(z)&"_1", accel_negy,	"filter_electrodes_3rd:fe_ch3_3rd_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch3_3rd_"&z, accel_posy, "filter_electrodes_3rd:fe_ch3_3rd_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''2
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+1*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+2*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_2_end To (n_electrodes_filter_stage_3_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_4-injection_half_drift_voltage_4)+ ( (negy4t-offset*vscale4*Bx_Normalized(z))-(injection_potential_4-injection_half_drift_voltage_4) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Normalized(z)
		Else
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch2_3rd_"&z, "filter_electrodes_3rd", "PEC", x1, x2, (filter_dimension_half_y_stage_3+electrode_thickness), (filter_dimension_half_y_stage_3+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_3rd:fe_ch2_3rd_"&z)
		MakePotential( "fe_ch2_3rd_"&CStr(z)&"_1", accel_negy, "filter_electrodes_3rd:fe_ch2_3rd_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch2_3rd_"&z, accel_posy, "filter_electrodes_3rd:fe_ch2_3rd_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''1
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+0*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+1*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_2_end To (n_electrodes_filter_stage_3_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_5-injection_half_drift_voltage_5)+ ( (negy5t-offset*vscale5*Bx_Normalized(z))-(injection_potential_5-injection_half_drift_voltage_5) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy5t -offset*vscale5*Bx_Normalized(z)
		Else
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy5t -offset*vscale5*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch1_3rd_"&z, "filter_electrodes_3rd", "PEC", x1, x2, (filter_dimension_half_y_stage_3+electrode_thickness), (filter_dimension_half_y_stage_3+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_3rd:fe_ch1_3rd_"&z)
		MakePotential( "fe_ch1_3rd_"&CStr(z)&"_1", accel_negy, "filter_electrodes_3rd:fe_ch1_3rd_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch1_3rd_"&z, accel_posy, "filter_electrodes_3rd:fe_ch1_3rd_"&z, "3")
	Next

End Sub
Sub Make_Filter_Stage_4_Electrodes()

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''bounce

	For z = n_electrodes_filter_stage_3_end To n_electrodes_filter_stage_4_end-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		MakeBrick("b_top_4th_"&z, "bounce_electrodes_4th", "PEC", (filter_dimension_half_x-electrode_thickness), (filter_dimension_half_x-electrode_thickness), -(filter_dimension_half_y_stage_4-electrode_thickness), (filter_dimension_half_y_stage_4-electrode_thickness), _
			zstart, zstart+electrode_length_z)
		MakeBrick("b_bot_4th_"&z, "bounce_electrodes_4th", "PEC", -(filter_dimension_half_x-electrode_thickness), -(filter_dimension_half_x-electrode_thickness), -(filter_dimension_half_y_stage_4-electrode_thickness), (filter_dimension_half_y_stage_4-electrode_thickness), _
			zstart, zstart+electrode_length_z)

		If z<n_electrodes_accel_region_end Then
			bv_top = injection_bounce_voltage
			bv_bot = injection_bounce_voltage
		Else
			bv_top = injection_bounce_voltage*Sqr(Bx_Normalized(z))
			bv_bot = injection_bounce_voltage*Sqr(Bx_Normalized(z))
		End If

		MakePotential( "b_top_4th_"&z, bv_top, "bounce_electrodes_4th:b_top_4th_"&z, "4")
		MakePotential( "b_bot_4th_"&z, bv_bot, "bounce_electrodes_4th:b_bot_4th_"&z, "4")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''5
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+4*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+5*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_3_end To (n_electrodes_filter_stage_4_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_5-injection_half_drift_voltage_5)+ ( (negy5t-offset*vscale5*Bx_Normalized(z))-(injection_potential_5-injection_half_drift_voltage_5) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy5t -offset*vscale5*Bx_Normalized(z)
		Else
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy5t -offset*vscale5*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch5_4th_"&z, "filter_electrodes_4th", "PEC", x1, x2, (filter_dimension_half_y_stage_4+electrode_thickness), (filter_dimension_half_y_stage_4+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_4th:fe_ch5_4th_"&z)
		MakePotential( "fe_ch5_4th_"&CStr(z)&"_1", accel_negy, "filter_electrodes_4th:fe_ch5_4th_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch5_4th_"&z, accel_posy, "filter_electrodes_4th:fe_ch5_4th_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''4
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+3*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+4*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_3_end To (n_electrodes_filter_stage_4_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_4-injection_half_drift_voltage_4)+ ( (negy4t-offset*vscale4*Bx_Normalized(z))-(injection_potential_4-injection_half_drift_voltage_4) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Normalized(z)
		Else
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch4_4th_"&z, "filter_electrodes_4th", "PEC", x1, x2, (filter_dimension_half_y_stage_4+electrode_thickness), (filter_dimension_half_y_stage_4+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_4th:fe_ch4_4th_"&z)
		MakePotential( "fe_ch4_4th_"&CStr(z)&"_1", accel_negy, "filter_electrodes_4th:fe_ch4_4th_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch4_4th_"&z, accel_posy, "filter_electrodes_4th:fe_ch4_4th_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''3
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+2*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+3*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_3_end To (n_electrodes_filter_stage_4_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale3*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_3-injection_half_drift_voltage_3)+ ( (negy3t-offset*vscale3*Bx_Normalized(z))-(injection_potential_3-injection_half_drift_voltage_3) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale3*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy3t -offset*vscale3*Bx_Normalized(z)
		Else
			accel_posy = vscale3*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy3t -offset*vscale3*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch3_4th_"&z, "filter_electrodes_4th", "PEC", x1, x2, (filter_dimension_half_y_stage_4+electrode_thickness), (filter_dimension_half_y_stage_4+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_4th:fe_ch3_4th_"&z)
		MakePotential( "fe_ch3_4th_"&CStr(z)&"_1", accel_negy,	"filter_electrodes_4th:fe_ch3_4th_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch3_4th_"&z, accel_posy, "filter_electrodes_4th:fe_ch3_4th_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''2
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+1*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+2*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_3_end To (n_electrodes_filter_stage_4_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_4-injection_half_drift_voltage_4)+ ( (negy4t-offset*vscale4*Bx_Normalized(z))-(injection_potential_4-injection_half_drift_voltage_4) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Normalized(z)
		Else
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch2_4th_"&z, "filter_electrodes_4th", "PEC", x1, x2, (filter_dimension_half_y_stage_4+electrode_thickness), (filter_dimension_half_y_stage_4+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_4th:fe_ch2_4th_"&z)
		MakePotential( "fe_ch2_4th_"&CStr(z)&"_1", accel_negy, "filter_electrodes_4th:fe_ch2_4th_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch2_4th_"&z, accel_posy, "filter_electrodes_4th:fe_ch2_4th_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''1
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+0*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+1*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_3_end To (n_electrodes_filter_stage_4_end+n_electrode_overlap_between_filter_stages)-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_5-injection_half_drift_voltage_5)+ ( (negy5t-offset*vscale5*Bx_Normalized(z))-(injection_potential_5-injection_half_drift_voltage_5) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy5t -offset*vscale5*Bx_Normalized(z)
		Else
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy5t -offset*vscale5*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch1_4th_"&z, "filter_electrodes_4th", "PEC", x1, x2, (filter_dimension_half_y_stage_4+electrode_thickness), (filter_dimension_half_y_stage_4+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_4th:fe_ch1_4th_"&z)
		MakePotential( "fe_ch1_4th_"&CStr(z)&"_1", accel_negy, "filter_electrodes_4th:fe_ch1_4th_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch1_4th_"&z, accel_posy, "filter_electrodes_4th:fe_ch1_4th_"&z, "3")
	Next

End Sub
Sub Make_Filter_Stage_5_Electrodes()

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''bounce

	For z = n_electrodes_filter_stage_4_end To n_electrodes_filter_stage_5_end-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		MakeBrick("b_top_5th_"&z, "bounce_electrodes_5th", "PEC", (filter_dimension_half_x-electrode_thickness), (filter_dimension_half_x-electrode_thickness), -(filter_dimension_half_y_stage_5-electrode_thickness), (filter_dimension_half_y_stage_5-electrode_thickness), _
			zstart, zstart+electrode_length_z)
		MakeBrick("b_bot_5th_"&z, "bounce_electrodes_5th", "PEC", -(filter_dimension_half_x-electrode_thickness), -(filter_dimension_half_x-electrode_thickness), -(filter_dimension_half_y_stage_5-electrode_thickness), (filter_dimension_half_y_stage_5-electrode_thickness), _
			zstart, zstart+electrode_length_z)

		If z<n_electrodes_accel_region_end Then
			bv_top = injection_bounce_voltage
			bv_bot = injection_bounce_voltage
		Else
			bv_top = injection_bounce_voltage*Sqr(Bx_Normalized(z))
			bv_bot = injection_bounce_voltage*Sqr(Bx_Normalized(z))
		End If

		MakePotential( "b_top_5th_"&z, bv_top, "bounce_electrodes_5th:b_top_5th_"&z, "4")
		MakePotential( "b_bot_5th_"&z, bv_bot, "bounce_electrodes_5th:b_bot_5th_"&z, "4")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''5
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+4*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+5*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_4_end To n_electrodes_filter_stage_5_end-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_5-injection_half_drift_voltage_5)+ ( (negy5t-offset*vscale5*Bx_Normalized(z))-(injection_potential_5-injection_half_drift_voltage_5) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy5t -offset*vscale5*Bx_Normalized(z)
		Else
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy5t -offset*vscale5*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch5_5th_"&z, "filter_electrodes_5th", "PEC", x1, x2, (filter_dimension_half_y_stage_5+electrode_thickness), (filter_dimension_half_y_stage_5+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_5th:fe_ch5_5th_"&z)
		MakePotential( "fe_ch5_5th_"&CStr(z)&"_1", accel_negy, "filter_electrodes_5th:fe_ch5_5th_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch5_5th_"&z, accel_posy, "filter_electrodes_5th:fe_ch5_5th_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''4
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+3*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+4*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_4_end To n_electrodes_filter_stage_5_end-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_4-injection_half_drift_voltage_4)+ ( (negy4t-offset*vscale4*Bx_Normalized(z))-(injection_potential_4-injection_half_drift_voltage_4) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Normalized(z)
		Else
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch4_5th_"&z, "filter_electrodes_5th", "PEC", x1, x2, (filter_dimension_half_y_stage_5+electrode_thickness), (filter_dimension_half_y_stage_5+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_5th:fe_ch4_5th_"&z)
		MakePotential( "fe_ch4_5th_"&CStr(z)&"_1", accel_negy, "filter_electrodes_5th:fe_ch4_5th_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch4_5th_"&z, accel_posy, "filter_electrodes_5th:fe_ch4_5th_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''3
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+2*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+3*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_4_end To n_electrodes_filter_stage_5_end-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale3*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_3-injection_half_drift_voltage_3)+ ( (negy3t-offset*vscale3*Bx_Normalized(z))-(injection_potential_3-injection_half_drift_voltage_3) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale3*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy3t -offset*vscale3*Bx_Normalized(z)
		Else
			accel_posy = vscale3*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy3t -offset*vscale3*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch3_5th_"&z, "filter_electrodes_5th", "PEC", x1, x2, (filter_dimension_half_y_stage_5+electrode_thickness), (filter_dimension_half_y_stage_5+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_5th:fe_ch3_5th_"&z)
		MakePotential( "fe_ch3_5th_"&CStr(z)&"_1", accel_negy,	"filter_electrodes_5th:fe_ch3_5th_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch3_5th_"&z, accel_posy, "filter_electrodes_5th:fe_ch3_5th_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''2
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+1*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+2*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_4_end To n_electrodes_filter_stage_5_end-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_4-injection_half_drift_voltage_4)+ ( (negy4t-offset*vscale4*Bx_Normalized(z))-(injection_potential_4-injection_half_drift_voltage_4) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Normalized(z)
		Else
			accel_posy = vscale4*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy4t -offset*vscale4*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch2_5th_"&z, "filter_electrodes_5th", "PEC", x1, x2, (filter_dimension_half_y_stage_5+electrode_thickness), (filter_dimension_half_y_stage_5+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_5th:fe_ch2_5th_"&z)
		MakePotential( "fe_ch2_5th_"&CStr(z)&"_1", accel_negy, "filter_electrodes_5th:fe_ch2_5th_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch2_5th_"&z, accel_posy, "filter_electrodes_5th:fe_ch2_5th_"&z, "3")
	Next

	'''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''''
	''''''''1
	x1 = -(filter_dimension_half_x-2*electrode_thickness)+0*((2*filter_dimension_half_x-4*electrode_thickness)/5)+electrode_thickness
	x2 = -(filter_dimension_half_x-2*electrode_thickness)+1*((2*filter_dimension_half_x-4*electrode_thickness)/5)-electrode_thickness

	For z = n_electrodes_filter_stage_4_end To n_electrodes_filter_stage_5_end-1
		zstart = injection_electrode_z_end +z*electrode_step_z+electrode_gap_z

		If z<n_electrodes_accel_region_end Then
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = (injection_potential_5-injection_half_drift_voltage_5)+ ( (negy5t-offset*vscale5*Bx_Normalized(z))-(injection_potential_5-injection_half_drift_voltage_5) )*(z/n_electrodes_accel_region_end)
		ElseIf z>=n_electrodes_accel_region_end And z<n_electrodes_filter_region_start Then
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy5t -offset*vscale5*Bx_Normalized(z)
		Else
			accel_posy = vscale5*Bx_Lambda_Adjusted_Filter(z)
			accel_negy = negy5t -offset*vscale5*Bx_Lambda_Adjusted_Filter(z)
		End If

		MakeBrick("fe_ch1_5th_"&z, "filter_electrodes_5th", "PEC", x1, x2, (filter_dimension_half_y_stage_5+electrode_thickness), (filter_dimension_half_y_stage_5+electrode_thickness), zstart, zstart+electrode_length_z)
		MirrorCopyY("filter_electrodes_5th:fe_ch1_5th_"&z)
		MakePotential( "fe_ch1_5th_"&CStr(z)&"_1", accel_negy, "filter_electrodes_5th:fe_ch1_5th_"&CStr(z)&"_1", "3")
		MakePotential( "fe_ch1_5th_"&z, accel_posy, "filter_electrodes_5th:fe_ch1_5th_"&z, "3")
	Next

End Sub

''''''' Backplate

Sub Make_Backplate_PCB()
	MakeCylinderX( "backcylinder_pcb", "target", "Epoxy resin", _
		0, filter_dimension_half_y_stage_5+electrode_thickness, _
		-(filter_dimension_half_x), (filter_dimension_half_x), _
		0, _
		catchz _
	)
	MakeCylinderX( "backcylinder_pcb_cutout", "target", "Vacuum", _
		0, filter_dimension_half_y_stage_5, _
		-(filter_dimension_half_x-1*electrode_thickness), (filter_dimension_half_x-1*electrode_thickness), _
		0, _
		catchz _
	)
	MakeBrick("backcylinder_box_cutout", "target", "Vacuum", _
		-filter_dimension_half_x, filter_dimension_half_x, -bring_cutout_y, bring_cutout_y, catchz -0.2, bring_cutout_z)

	Solid.Subtract "target:backcylinder_pcb", "target:backcylinder_pcb_cutout"
	Solid.Subtract "target:backcylinder_pcb", "target:backcylinder_box_cutout"
End Sub


''''''' Particles

Sub Make_Test_Particles()
	Dim n_pitch, n_theta, n_bunch, n_energies As Integer
	Dim pitch_start, pitch_step, ipitch, _
		theta_start, theta_step, ienergy, _
		energy_step, bunch_separation, KE, pitch As Double

	pitch = 85
	n_pitch = 5
	pitch_step = 20

	KE = 18600
	n_energies = 1
	energy_step = 7000

	n_theta = 4
	theta_start = 0
	theta_step = 90

	n_bunch = 1
	bunch_separation = 0.3

	For i = 1 To n_pitch
		For j = 1 To n_energies
			For k = 1 To n_bunch

			' x +y
			' x +z
			' x -y
			' x -z                                                                                                                                                

			ipitch = pitch-(i-1)*pitch_step
			ienergy = KE-(j-1)*energy_step

			' MakeParticle( "z2_p"&(ipitch)&"_th0_e"&(ienergy), _
			' 	perm_magnet_x+electrode_thickness*CosD(perm_magnet_rotation_deg), 0, perm_magnet_z-electrode_thickness*SinD(perm_magnet_rotation_deg), _
			' 	CosD(perm_magnet_rotation_deg)*CosD(ipitch), SinD(ipitch), -SinD(perm_magnet_rotation_deg)*CosD(ipitch), _
			' 	ienergy _
			' )
			' MakeParticle( "z2_p"&(ipitch)&"_th90_e"&(ienergy), _
			' 	perm_magnet_x+electrode_thickness*CosD(perm_magnet_rotation_deg), 0, perm_magnet_z-electrode_thickness*SinD(perm_magnet_rotation_deg), _
			' 	CosD(perm_magnet_rotation_deg)*CosD(ipitch)+SinD(perm_magnet_rotation_deg)*SinD(ipitch), 0, -SinD(perm_magnet_rotation_deg)*CosD(ipitch)+CosD(perm_magnet_rotation_deg)*SinD(ipitch), _
			' 	ienergy _
			' )
			MakeParticle( "z2_p"&(ipitch)&"_th180_e"&(ienergy), _
				perm_magnet_x+electrode_thickness*CosD(perm_magnet_rotation_deg), 0, perm_magnet_z-electrode_thickness*SinD(perm_magnet_rotation_deg), _
				CosD(perm_magnet_rotation_deg)*CosD(ipitch), -SinD(ipitch), -SinD(perm_magnet_rotation_deg)*CosD(ipitch), _
				ienergy _
			)
			' MakeParticle( "z2_p"&(ipitch)&"_th270_e"&(ienergy), _
			' 	perm_magnet_x+electrode_thickness*CosD(perm_magnet_rotation_deg), 0, perm_magnet_z-electrode_thickness*SinD(perm_magnet_rotation_deg), _
			' 	CosD(perm_magnet_rotation_deg)*CosD(ipitch) -SinD(perm_magnet_rotation_deg)*SinD(ipitch), 0, -SinD(perm_magnet_rotation_deg)*CosD(ipitch) -CosD(perm_magnet_rotation_deg)*SinD(ipitch), _
			' 	ienergy _
			' )

			Next
		Next
	Next
End Sub
Sub Make_Particle_Ring_Emission()

	' emission density, scale factor
	' 90, 1 = 3497 @ 0.0045 to 0.0055

	' MakeCylinderX( "ring", "target", "Vacuum", _
	' 	particle_ring_emission_radius_inner, particle_ring_emission_radius_outer, _
	' 	perm_magnet_x-electrode_thickness, perm_magnet_x+electrode_thickness, _
	' 	0, _
	' 	perm_magnet_z _
	' )
	' RotateCommonCenterY("target:ring", perm_magnet_rotation_deg)

	' With ParticleSource
	' 	.Reset
	' 	.Name "particle1"
	' 	.ParticleType "electron"
	' 	.Charge "-1.602176634e-19"
	' 	.Mass "9.1093837015e-31"
	' 	.SourceType "Faces"
	' 	.AddFace "target:ring", "3"
	' 	.ScaleTriangularizationToMesh "True"
	' 	.FacetOptions "90", "1" ' emission density, max scale factor
	' 	.TrkEmissionModel "Fixed"
	' 	.TrkKinetic "Energy", "Uniform", "18600", "0", pitchrange, "300", "100"
	' 	.TrkFixed "1", "CURRENT"
	' 	.Create
	' End With

	' For particle_ring_emission_theta = 20 To 20 Step 10
		' For particle_ring_emission_phi = 0 To 315 Step 45

	With ParticleSource
		.Reset
		.Name "pring_th"&CStr(particle_ring_emission_theta)&"_phi"&CStr(particle_ring_emission_phi)
		.ParticleType "electron"
		.Charge "-1.602176634e-19"
		.Mass "9.1093837015e-31"
		.SourceType "Circle"
		.UsePickCircle "False"
		.CircleCenterPoint "-0.25272553725231", "0", "-1.302961597733"
		.CircleNormal "0.27446274768781", "0", "-0.96159773301088"
		.CircleRadius particle_ring_emission_radius_outer
		.CircleRadiusInner particle_ring_emission_radius_inner
		.CircleRadiusLines particle_ring_emission_lines_n
		.CircleOblique particle_ring_emission_theta, particle_ring_emission_phi
		.RadialFunction "constant"
		.TrkEmissionModel "Fixed"
		.TrkKinetic "Energy", "Uniform", "18600", "0", particle_ring_emission_theta_spread_plusminus, "300", "100"
		.TrkFixed "1", "CURRENT"
		.Create
	End With

		' Next
	' Next

End Sub

''''''' Helper Functions

Sub MakeBrick( _
	name As String, comp As String, mat As String, _
	x1 As Double, x2 As Double, _
	y1 As Double, y2 As Double, _
	z1 As Double, z2 As Double)

    With Brick
        .Reset
        .Name name
        .Component comp
        .Material mat
        .Xrange x1, x2
        .Yrange y1, y2
        .Zrange z1, z2
        .Create
    End With
End Sub
Sub MakeCylinderX( _
	name As String, comp As String, mat As String, _
	Rin As Double, Rout As Double, _
	x1 As Double, x2 As Double, _
	ycenter As Double, _
	zcenter As Double)

	With Cylinder 
		.Reset 
		.Name name 
		.Component comp
		.Material mat
		.InnerRadius Rin
		.OuterRadius Rout 
		.Axis "x" 
		.Xrange x1, x2
		.Ycenter ycenter
		.Zcenter zcenter
		.Segments "0" 
		.Create 
	End With
End Sub
Sub MakeSweepCurve( _
	name As String, comp As String, mat As String, _
	cross_section As String, profile As String _
	)

	With SweepCurve
		.Reset
		.Name name
		.Component comp
		.Material mat
		.Twistangle "0.0"
		.Taperangle "0.0"
		.ProjectProfileToPathAdvanced "True"
		.CutEndOff "True"
		.DeleteProfile "True"
		.DeletePath "True"
		.Path profile
		.Curve cross_section
		.Create
	End With
End Sub
Sub MirrorCopyMagnetsX( _
	solidname As String _
	)

	With Transform 
		.Reset 
		.Name solidname
		.Origin "Free" 
		.Center "0", "0", "0" 
		.PlaneNormal "1", "0", "0" 
		.MultipleObjects "True" 
		.GroupObjects "False" 
		.Repetitions "1" 
		.MultipleSelection "False" 
		.Destination "" 
		.Material "" 
		.AutoDestination "True"
		.CopyAttached "Magnets"
		.Transform "Shape", "Mirror"
	End With

End Sub
Sub MirrorCopyY( _
	solidname As String _
	)

	With Transform 
		.Reset 
		.Name solidname
		.Origin "Free" 
		.Center "0", "0", "0" 
		.PlaneNormal "0", "1", "0" 
		.MultipleObjects "True" 
		.GroupObjects "False" 
		.Repetitions "1" 
		.MultipleSelection "False" 
		.Destination "" 
		.Material "" 
		.AutoDestination "True" 
		.Transform "Shape", "Mirror" 
	End With

End Sub
Sub MirrorCopyX( _
	solidname As String _
	)

	With Transform 
		.Reset 
		.Name solidname
		.Origin "Free" 
		.Center "0", "0", "0" 
		.PlaneNormal "1", "0", "0" 
		.MultipleObjects "True" 
		.GroupObjects "False" 
		.Repetitions "1" 
		.MultipleSelection "False" 
		.Destination "" 
		.Material "" 
		.AutoDestination "True" 
		.Transform "Shape", "Mirror" 
	End With

End Sub
Sub RotateCommonCenterY( _
	solidname As String, rotdeg as Double _
	)

	With Transform 
		.Reset 
		.Name solidname 
		.Origin "CommonCenter" 
		.Center "0", "0", "0" 
		.Angle "0", rotdeg, "0" 
		.MultipleObjects "False" 
		.GroupObjects "False" 
		.Repetitions "1" 
		.MultipleSelection "False" 
		.AutoDestination "True" 
		.Transform "Shape", "Rotate" 
	End With

End Sub
Sub RotateFreeCenterY( _
	solidname As String, rotdeg As Double, _
	cx As Double, cy As Double, cz As Double _
	)

	With Transform 
		.Reset 
		.Name solidname
		.Origin "Free" 
		.Center cx, cy, cz
		.Angle "0", rotdeg, "0" 
		.MultipleObjects "False" 
		.GroupObjects "False" 
		.Repetitions "1" 
		.MultipleSelection "False" 
		.AutoDestination "True" 
		.Transform "Shape", "Rotate" 
	End With
End Sub
Sub MakePotential( _
	name As String, value As Double, _
	solidname As String, face As String )

	With Potential
		.Reset
		.Name name
		.Value value
		.Phase "0"
		.AddFace solidname, face
		.Type "Fixed"
		.Create
	End With
End Sub
Sub MakeParticle( _
	name As String, _
	px As Double, py As Double, pz As Double, _
	nx As Double, ny As Double, nz As Double, _
	energy As Double _
	)

	With ParticleSource
		.Reset
		.Name name
		.ParticleType "electron"
		.Charge "-1.602176565e-19"
		.Mass "9.1093810e-31"
		.SourceType "SinglePoint"
		.UsePickPoint "False"
		.StartPoint px, py, pz
		.StartNormal nx, ny, nz
		.StartArea "1e-9"
		.TrkEmissionModel "Fixed"
		.TrkKinetic "Energy", "Uniform", energy, "0", "0", "300", "100"
		.TrkFixed "1", "CURRENT"
		.Create
	End With
End Sub

''''''' Mesh and Simulation

Sub Make_Uniform_Mesh()

	Group.Add "localized_mesh", "mesh"
	Group.Add "catch_mesh", "mesh"

	With Mesh 
	     .MeshType "PBA" 
	     .SetCreator "Tracking"
	End With 
	With MeshSettings 
	     .SetMeshType "Hex" 
	     .Set "Version", 1%
	     'MAX CELL - WAVELENGTH REFINEMENT 
	     .Set "StepsPerWaveNear", "22" 
	     .Set "StepsPerWaveFar", "5" 
	     .Set "WavelengthRefinementSameAsNear", "0" 
	     'MAX CELL - GEOMETRY REFINEMENT 
	     .Set "StepsPerBoxNear", "15" 
	     .Set "StepsPerBoxFar", "15" 
	     .Set "MaxStepNear", "0.1" 
	     .Set "MaxStepFar", "0.1" 
	     .Set "ModelBoxDescrNear", "maxedge" 
	     .Set "ModelBoxDescrFar", "maxedge" 
	     .Set "UseMaxStepAbsolute", "0" 
	     .Set "GeometryRefinementSameAsNear", "0" 
	     'MIN CELL 
	     .Set "UseRatioLimitGeometry", "0" 
	     .Set "RatioLimitGeometry", "90" 
	     .Set "MinStepGeometryX", uniform_mesh_step_x_global
	     .Set "MinStepGeometryY", uniform_mesh_step_y_global
	     .Set "MinStepGeometryZ", uniform_mesh_step_z_global
	     .Set "UseSameMinStepGeometryXYZ", "1" 
	End With 
	With MeshSettings 
	     .Set "PlaneMergeVersion", "2" 
	End With 
	With MeshSettings 
	     .SetMeshType "Hex" 
	     .Set "FaceRefinementType", "NONE" 
	     .Set "FaceRefinementRatio", "2" 
	     .Set "FaceRefinementStep", "0" 
	     .Set "FaceRefinementNSteps", "2" 
	     .Set "EllipseRefinementType", "NONE" 
	     .Set "EllipseRefinementRatio", "2" 
	     .Set "EllipseRefinementStep", "0" 
	     .Set "EllipseRefinementNSteps", "2" 
	     .Set "FaceRefinementBufferLines", "3" 
	     .Set "EdgeRefinementType", "RATIO" 
	     .Set "EdgeRefinementRatio", "2" 
	     .Set "EdgeRefinementStep", "0" 
	     .Set "EdgeRefinementBufferLines", "3" 
	     .Set "RefineEdgeMaterialGlobal", "0" 
	     .Set "RefineAxialEdgeGlobal", "0" 
	     .Set "BufferLinesNear", "3" 
	     .Set "UseDielectrics", "1" 
	     .Set "EquilibrateOn", "0" 
	     .Set "Equilibrate", "1.5" 
	     .Set "IgnoreThinPanelMaterial", "0" 
	End With 
	With MeshSettings 
	     .SetMeshType "Hex" 
	     .Set "SnapToAxialEdges", "1"
	     .Set "SnapToPlanes", "1"
	     .Set "SnapToSpheres", "1"
	     .Set "SnapToEllipses", "1"
	     .Set "SnapToCylinders", "1"
	     .Set "SnapToCylinderCenters", "1"
	     .Set "SnapToEllipseCenters", "1"
	     .Set "SnapToTori", "0"
	End With 
	With Mesh 
	     .ConnectivityCheck "True"
	     .UsePecEdgeModel "True" 
	     .PointAccEnhancement "0" 
	     .TSTVersion "2"
		  .PBAVersion "2020071020" 
	     .SetCADProcessingMethod "MultiThread22", "-1" 
	     .SetGPUForMatrixCalculationDisabled "False" 
	End With

	With MeshSettings
		With .ItemMeshSettings ("group$localized_mesh")
			.SetMeshType "Hex"
			.Set "EdgeRefinement", "20"
			.Set "Extend", "0", "0", "0"
			.Set "Fixpoints", 1
			.Set "MeshType", "Default"
			.Set "NumSteps", "0", "0", "0"
			.Set "Priority", "0"
			.Set "RefinementPolicy", "ABS_VALUE"
			.Set "SnappingIntervals", 0, 0, 0
			.Set "SnappingPriority", 0
			.Set "SnapTo", "1", "1", "1"
			.Set "Step", uniform_mesh_step_x_global, uniform_mesh_step_y_global, uniform_mesh_step_z_global
			.Set "StepRatio", "0", "0", "0"
			.Set "StepRefinementCollectPolicy", "REFINE_INTERIOR"
			.Set "StepRefinementExtentPolicy", "EXTENT_ABS_VALUE"
			.Set "UseDielectrics", 1
			.Set "UseEdgeRefinement", 0
			.Set "UseForRefinement", 1
			.Set "UseForSnapping", 1
			.Set "UseSameExtendXYZ", 1
			.Set "UseSameStepWidthXYZ", 0
			.Set "UseSnappingPriority", 0
			.Set "UseStepAndExtend", 1
			.Set "UseVolumeRefinement", 0
			.Set "VolumeRefinement", "1"
		End With
	End With
	With MeshSettings
		With .ItemMeshSettings ("group$catch_mesh")
			.SetMeshType "Hex"
			.Set "EdgeRefinement", "20"
			.Set "Extend", "0", "0", "0"
			.Set "Fixpoints", 1
			.Set "MeshType", "Default"
			.Set "NumSteps", "0", "0", "0"
			.Set "Priority", "0"
			.Set "RefinementPolicy", "ABS_VALUE"
			.Set "SnappingIntervals", 0, 0, 0
			.Set "SnappingPriority", 0
			.Set "SnapTo", "1", "1", "1"
			.Set "Step", 2*uniform_mesh_step_x_global, 2*uniform_mesh_step_y_global, 2*uniform_mesh_step_z_global
			.Set "StepRatio", "0", "0", "0"
			.Set "StepRefinementCollectPolicy", "REFINE_INTERIOR"
			.Set "StepRefinementExtentPolicy", "EXTENT_ABS_VALUE"
			.Set "UseDielectrics", 1
			.Set "UseEdgeRefinement", 0
			.Set "UseForRefinement", 1
			.Set "UseForSnapping", 1
			.Set "UseSameExtendXYZ", 1
			.Set "UseSameStepWidthXYZ", 0
			.Set "UseSnappingPriority", 0
			.Set "UseStepAndExtend", 1
			.Set "UseVolumeRefinement", 0
			.Set "VolumeRefinement", "1"
		End With
	End With

	MakeBrick("filter_mesh", "mesh", "Vacuum", _
		-filter_mesh_dimension_half_x, filter_mesh_dimension_half_x, _
		-filter_mesh_dimension_half_y, filter_mesh_dimension_half_y, _
		filter_mesh_z_start, filter_mesh_z_end _
	)
	Group.AddItem "solid$mesh:filter_mesh", "localized_mesh"
	Group.AddItem "solid$mesh:filter_mesh", "Excluded from Simulation"
	Group.AddItem "solid$mesh:filter_mesh", "Excluded from Bounding Box"

	MakeBrick("injection_mesh", "mesh", "Vacuum", _
		injection_mesh_x_start, injection_mesh_x_end, _
		-filter_mesh_dimension_half_y, filter_mesh_dimension_half_y, _
		injection_mesh_z_start, filter_mesh_z_start _
	)
	Group.AddItem "solid$mesh:injection_mesh", "localized_mesh"
	Group.AddItem "solid$mesh:injection_mesh", "Excluded from Simulation"
	Group.AddItem "solid$mesh:injection_mesh", "Excluded from Bounding Box"


End Sub
Sub DefineMaterials()
	' Iron
	With Material
		.Reset
		.Name "Iron-PEC"
		.Folder ""
		.Rho "7870.0"
		.ThermalType "Normal"
		.ThermalConductivity "79.5"
		.SpecificHeat "450", "J/K/kg"
		.DynamicViscosity "0"
		.Emissivity "0"
		.MetabolicRate "0"
		.VoxelConvection "0"
		.BloodFlow "0"
		.MechanicsType "Isotropic"
		.YoungsModulus "200"
		.PoissonsRatio "0.291"
		.ThermalExpansionRate "12"
		.FrqType "hf"
		.Type "Lossy metal"
		.MaterialUnit "Frequency", "Hz"
		.MaterialUnit "Geometry", "mm"
		.MaterialUnit "Time", "s"
		.Mu "1"
		.Sigma "1.04e+007"
		.LossyMetalSIRoughness "0.0"
		.ReferenceCoordSystem "Global"
		.CoordSystemType "Cartesian"
		.NonlinearMeasurementError "1e-1"
		.NLAnisotropy "False"
		.NLAStackingFactor "1"
		.NLADirectionX "1"
		.NLADirectionY "0"
		.NLADirectionZ "0"
		.FrqType "all"
		.Type "Normal"
		.MaterialUnit "Frequency", "Hz"
		.MaterialUnit "Geometry", "mm"
		.MaterialUnit "Time", "s"
		.Epsilon "1"
		.Mu "1000"
		.Sigma "1.04e+007"
		.TanD "0.0"
		.TanDFreq "0.0"
		.TanDGiven "False"
		.TanDModel "ConstSigma"
		.EnableUserConstTanDModelOrderEps "False"
		.ConstTanDModelOrderEps "1"
		.SetElParametricConductivity "False"
		.ReferenceCoordSystem "Global"
		.CoordSystemType "Cartesian"
		.SigmaM "0"
		.TanDM "0.0"
		.TanDMFreq "0.0"
		.TanDMGiven "False"
		.TanDMModel "ConstSigma"
		.EnableUserConstTanDModelOrderMu "False"
		.ConstTanDModelOrderMu "1"
		.SetMagParametricConductivity "False"
		.DispModelEps  "None"
		.DispModelMu "None"
		.DispersiveFittingSchemeEps "Nth Order"
		.MaximalOrderNthModelFitEps "10"
		.ErrorLimitNthModelFitEps "0.1"
		.UseOnlyDataInSimFreqRangeNthModelEps "False"
		.DispersiveFittingSchemeMu "Nth Order"
		.MaximalOrderNthModelFitMu "10"
		.ErrorLimitNthModelFitMu "0.1"
		.UseOnlyDataInSimFreqRangeNthModelMu "False"
		.UseGeneralDispersionEps "False"
		.UseGeneralDispersionMu "False"
		.NonlinearMeasurementError "1e-3"
		.ResetHBList
		.SetNonlinearCurveType "Soft-Magnetic-BH"
		.AddNonlinearCurveValue " 0.000000e+000", " 0.000000e+000"
		.AddNonlinearCurveValue " 1.592000e+001", " 4.500000e-002"
		.AddNonlinearCurveValue " 3.183000e+001", " 4.900000e-001"
		.AddNonlinearCurveValue " 4.775000e+001", " 7.800000e-001"
		.AddNonlinearCurveValue " 6.366000e+001", " 9.900000e-001"
		.AddNonlinearCurveValue " 7.958000e+001", " 1.130000e+000"
		.AddNonlinearCurveValue " 1.592000e+002", " 1.420000e+000"
		.AddNonlinearCurveValue " 3.183000e+002", " 1.570000e+000"
		.AddNonlinearCurveValue " 4.775000e+002", " 1.621000e+000"
		.AddNonlinearCurveValue " 6.366000e+002", " 1.641000e+000"
		.AddNonlinearCurveValue " 7.958000e+002", " 1.656000e+000"
		.AddNonlinearCurveValue " 1.592000e+003", " 1.697000e+000"
		.AddNonlinearCurveValue " 3.183000e+003", " 1.764000e+000"
		.AddNonlinearCurveValue " 4.775000e+003", " 1.801000e+000"
		.AddNonlinearCurveValue " 6.366000e+003", " 1.838000e+000"
		.AddNonlinearCurveValue " 7.958000e+003", " 1.870000e+000"
		.AddNonlinearCurveValue " 1.592000e+004", " 2.000000e+000"
		.AddNonlinearCurveValue " 3.183000e+004", " 2.136000e+000"
		.AddNonlinearCurveValue " 4.775000e+004", " 2.185000e+000"
		.AddNonlinearCurveValue " 6.366000e+004", " 2.220000e+000"
		.AddNonlinearCurveValue " 7.958000e+004", " 2.250000e+000"
		.AddNonlinearCurveValue " 1.592000e+005", " 2.355000e+000"
		.AddNonlinearCurveValue " 3.183000e+005", " 2.556000e+000"
		.GenerateNonlinearCurve
		.NLAnisotropy "False"
		.NLAStackingFactor "1"
		.NLADirectionX "1"
		.NLADirectionY "0"
		.NLADirectionZ "0"
		.FrqType "static"
		.Type "Pec"
		.MaterialUnit "Frequency", "Hz"
		.MaterialUnit "Geometry", "mm"
		.MaterialUnit "Time", "s"
		.Epsilon "1.0"
		.Mu "4000"
		.ReferenceCoordSystem "Global"
		.CoordSystemType "Cartesian"
		.NonlinearMeasurementError "1e-3"
		.ResetHBList
		.SetNonlinearCurveType "Soft-Magnetic-BH"
		.AddNonlinearCurveValue " 0.000000e+000", " 0.000000e+000"
		.AddNonlinearCurveValue " 1.592000e+001", " 4.500000e-002"
		.AddNonlinearCurveValue " 3.183000e+001", " 4.900000e-001"
		.AddNonlinearCurveValue " 4.775000e+001", " 7.800000e-001"
		.AddNonlinearCurveValue " 6.366000e+001", " 9.900000e-001"
		.AddNonlinearCurveValue " 7.958000e+001", " 1.130000e+000"
		.AddNonlinearCurveValue " 1.592000e+002", " 1.420000e+000"
		.AddNonlinearCurveValue " 3.183000e+002", " 1.570000e+000"
		.AddNonlinearCurveValue " 4.775000e+002", " 1.621000e+000"
		.AddNonlinearCurveValue " 6.366000e+002", " 1.641000e+000"
		.AddNonlinearCurveValue " 7.958000e+002", " 1.656000e+000"
		.AddNonlinearCurveValue " 1.592000e+003", " 1.697000e+000"
		.AddNonlinearCurveValue " 3.183000e+003", " 1.764000e+000"
		.AddNonlinearCurveValue " 4.775000e+003", " 1.801000e+000"
		.AddNonlinearCurveValue " 6.366000e+003", " 1.838000e+000"
		.AddNonlinearCurveValue " 7.958000e+003", " 1.870000e+000"
		.AddNonlinearCurveValue " 1.592000e+004", " 2.000000e+000"
		.AddNonlinearCurveValue " 3.183000e+004", " 2.136000e+000"
		.AddNonlinearCurveValue " 4.775000e+004", " 2.185000e+000"
		.AddNonlinearCurveValue " 6.366000e+004", " 2.220000e+000"
		.AddNonlinearCurveValue " 7.958000e+004", " 2.250000e+000"
		.AddNonlinearCurveValue " 1.592000e+005", " 2.355000e+000"
		.AddNonlinearCurveValue " 3.183000e+005", " 2.556000e+000"
		.GenerateNonlinearCurve
		.NLAnisotropy "False"
		.NLAStackingFactor "1"
		.NLADirectionX "1"
		.NLADirectionY "0"
		.NLADirectionZ "0"
		.Colour "0", "0.25098", "0.25098"
		.Wireframe "False"
		.Reflection "False"
		.Allowoutline "True"
		.Transparentoutline "False"
		.Transparency "0"
		.Create
	End With

	With Material 
		.Reset 
		.Name "Iron-normal"
		.Folder ""
		.Rho "7870.0"
		.ThermalType "Normal"
		.ThermalConductivity "79.5"
		.SpecificHeat "450", "J/K/kg"
		.DynamicViscosity "0"
		.UseEmissivity "True"
		.Emissivity "0"
		.MetabolicRate "0"
		.VoxelConvection "0"
		.BloodFlow "0"
		.Absorptance "0"
		.MechanicsType "Isotropic"
		.YoungsModulus "200"
		.PoissonsRatio "0.291"
		.ThermalExpansionRate "12"
		.IntrinsicCarrierDensity "0"
		.FrqType "static"
		.Type "Normal"
		.MaterialUnit "Frequency", "Hz"
		.MaterialUnit "Geometry", "mm"
		.MaterialUnit "Time", "s"
		.Epsilon "1.0"
		.Mu "1000"
		.Sigma "0.0"
		.TanD "0.0"
		.TanDFreq "0.0"
		.TanDGiven "False"
		.TanDModel "ConstTanD"
		.SetConstTanDStrategyEps "AutomaticOrder"
		.ConstTanDModelOrderEps "3"
		.DjordjevicSarkarUpperFreqEps "0"
		.SetElParametricConductivity "False"
		.ReferenceCoordSystem "Global"
		.CoordSystemType "Cartesian"
		.SigmaM "0"
		.TanDM "0.0"
		.TanDMFreq "0.0"
		.TanDMGiven "False"
		.TanDMModel "ConstTanD"
		.SetConstTanDStrategyMu "AutomaticOrder"
		.ConstTanDModelOrderMu "3"
		.DjordjevicSarkarUpperFreqMu "0"
		.SetMagParametricConductivity "False"
		.DispModelEps  "None"
		.DispModelMu "None"
		.DispersiveFittingSchemeEps "Nth Order"
		.MaximalOrderNthModelFitEps "10"
		.ErrorLimitNthModelFitEps "0.1"
		.UseOnlyDataInSimFreqRangeNthModelEps "False"
		.DispersiveFittingSchemeMu "Nth Order"
		.MaximalOrderNthModelFitMu "10"
		.ErrorLimitNthModelFitMu "0.1"
		.UseOnlyDataInSimFreqRangeNthModelMu "False"
		.UseGeneralDispersionEps "False"
		.UseGeneralDispersionMu "False"
		.NonlinearMeasurementError "1e-3"
		.ResetHBList
		.SetNonlinearCurveType "Soft-Magnetic-BH"
		.AddNonlinearCurveValue "0", "0"
		.AddNonlinearCurveValue "10", "0.003"
		.AddNonlinearCurveValue "25", "0.007"
		.AddNonlinearCurveValue "50", "0.015"
		.AddNonlinearCurveValue "75", "0.026"
		.AddNonlinearCurveValue "108", "0.05"
		.AddNonlinearCurveValue "137", "0.1"
		.AddNonlinearCurveValue "160", "0.15"
		.AddNonlinearCurveValue "180", "0.2"
		.AddNonlinearCurveValue "200", "0.25"
		.AddNonlinearCurveValue "235", "0.35"
		.AddNonlinearCurveValue "285", "0.5"
		.AddNonlinearCurveValue "320", "0.6"
		.AddNonlinearCurveValue "365", "0.7"
		.AddNonlinearCurveValue "480", "0.9"
		.AddNonlinearCurveValue "560", "1"
		.AddNonlinearCurveValue "660", "1.1"
		.AddNonlinearCurveValue "800", "1.2"
		.AddNonlinearCurveValue "1000", "1.3"
		.AddNonlinearCurveValue "1150", "1.354"
		.AddNonlinearCurveValue "1550", "1.45"
		.AddNonlinearCurveValue "1840", "1.5"
		.AddNonlinearCurveValue "2250", "1.55"
		.AddNonlinearCurveValue "2800", "1.6"
		.AddNonlinearCurveValue "3450", "1.65"
		.AddNonlinearCurveValue "4350", "1.7"
		.AddNonlinearCurveValue "5500", "1.75"
		.AddNonlinearCurveValue "7707", "1.81"
		.AddNonlinearCurveValue "1.1863e+04", "1.89"
		.AddNonlinearCurveValue "1.5839e+04", "1.945"
		.AddNonlinearCurveValue "2.1076e+04", "2"
		.AddNonlinearCurveValue "2.7281e+04", "2.05"
		.AddNonlinearCurveValue "3.5288e+04", "2.1"
		.AddNonlinearCurveValue "4.5642e+04", "2.15"
		.AddNonlinearCurveValue "5.9046e+04", "2.2"
		.AddNonlinearCurveValue "7.6412e+04", "2.25"
		.AddNonlinearCurveValue "9.8907e+04", "2.3"
		.AddNonlinearCurveValue "1.28e+05", "2.35"
		.AddNonlinearCurveValue "1.34764e+05", "2.36"
		.AddNonlinearCurveValue "1.4188e+05", "2.37"
		.AddNonlinearCurveValue "1.49364e+05", "2.38"
		.AddNonlinearCurveValue "1.57235e+05", "2.39"
		.GenerateNonlinearCurve
		.SetNonlinearTemperatureDependency "False"
		.SetNonlinearCurveDefaultTemperature "293.15"
		.SetNonlinearCurveTemperatureUnit "K"
		.AddNonlinearCurveTemperature "293.15"
		.NonlinearMeasurementError "1e-3"
		.ResetHBList
		.SetNonlinearCurveType "Soft-Magnetic-BH"
		.AddNonlinearCurveValue "0", "0"
		.AddNonlinearCurveValue "20.721094073771", "0.81103461961167"
		.AddNonlinearCurveValue "357.61648215026", "1.1023886087996"
		.AddNonlinearCurveValue "424.10899295483", "1.2111996180089"
		.AddNonlinearCurveValue "2496.5755665583", "1.6090577218477"
		.AddNonlinearCurveValue "3785.6748169637", "1.677520657793"
		.AddNonlinearCurveValue "5264.7637795276", "1.7482293320308"
		.AddNonlinearCurveValue "1.05157019846203e+04", "1.8714577846323"
		.AddNonlinearCurveValue "1.30532532117696e+04", "1.9093192382666"
		.AddNonlinearCurveValue "1.55908044389188e+04", "1.9470128175556"
		.AddNonlinearCurveValue "1.85145047658516e+04", "1.9798611959132"
		.AddNonlinearCurveValue "2.39757563199337e+04", "2.0241926531156"
		.AddNonlinearCurveValue "2.94370078740157e+04", "2.0627056065602"
		.AddNonlinearCurveValue "3.21676336510568e+04", "2.0812694042637"
		.AddNonlinearCurveValue "3.48982594280978e+04", "2.1002488093784"
		.AddNonlinearCurveValue "3.76288852051388e+04", "2.1106389946602"
		.AddNonlinearCurveValue "4.03595109821799e+04", "2.125046718251"
		.AddNonlinearCurveValue "4.30901367592209e+04", "2.1380690838042"
		.AddNonlinearCurveValue "4.85513883133029e+04", "2.1599577407979"
		.AddNonlinearCurveValue "5.1282014090344e+04", "2.1693781754534"
		.AddNonlinearCurveValue "5.4012639867385e+04", "2.1807381113615"
		.AddNonlinearCurveValue "5.6743265644426e+04", "2.1920980472696"
		.AddNonlinearCurveValue "6.22045171985081e+04", "2.2081682005055"
		.AddNonlinearCurveValue "6.49351429755491e+04", "2.2150949906934"
		.AddNonlinearCurveValue "6.76657687525901e+04", "2.2228529957038"
		.AddNonlinearCurveValue "7.03963945296312e+04", "2.2319963587518"
		.AddNonlinearCurveValue "7.31270203066722e+04", "2.2386460773321"
		.AddNonlinearCurveValue "7.85882718607542e+04", "2.2536079441379"
		.AddNonlinearCurveValue "8.13188976377953e+04", "2.2594264478957"
		.AddNonlinearCurveValue "8.40495234148363e+04", "2.2652449516535"
		.AddNonlinearCurveValue "8.67801491918773e+04", "2.2707863838038"
		.AddNonlinearCurveValue "8.95107749689184e+04", "2.2766048875617"
		.AddNonlinearCurveValue "9.22414007459594e+04", "2.283808749357"
		.AddNonlinearCurveValue "9.49720265230004e+04", "2.2893501815073"
		.AddNonlinearCurveValue "1.03163903854123e+05", "2.3048661915282"
		.AddNonlinearCurveValue "1.05894529631165e+05", "2.3092993372484"
		.AddNonlinearCurveValue "1.08625155408206e+05", "2.3151178410062"
		.AddNonlinearCurveValue "1.11355781185247e+05", "2.3187197719039"
		.AddNonlinearCurveValue "1.14086406962288e+05", "2.3220446311941"
		.AddNonlinearCurveValue "1.16817032739329e+05", "2.3275860633444"
		.AddNonlinearCurveValue "1.1954765851637e+05", "2.3331274954947"
		.AddNonlinearCurveValue "1.22278284293411e+05", "2.33811478443"
		.AddNonlinearCurveValue "1.25008910070452e+05", "2.3411625721126"
		.AddNonlinearCurveValue "1.27739535847493e+05", "2.3476910718647"
		.AddNonlinearCurveValue "1.30470161624534e+05", "2.3505830067681"
		.AddNonlinearCurveValue "1.3330422019616e+05", "2.3585488154842"
		.AddNonlinearCurveValue "1.35718637144041e+05", "2.3627939483279"
		.AddNonlinearCurveValue "1.38662038955657e+05", "2.3636053723213"
		.AddNonlinearCurveValue "1.44123290509739e+05", "2.3702550909017"
		.AddNonlinearCurveValue "1.4685391628678e+05", "2.3741340934069"
		.AddNonlinearCurveValue "1.49453121571878e+05", "2.3766114395447"
		.AddNonlinearCurveValue "1.52315167840862e+05", "2.3793984539497"
		.AddNonlinearCurveValue "1.55045793617903e+05", "2.3838315996699"
		.GenerateNonlinearCurve
		.NLAnisotropy "False"
		.NLAStackingFactor "1"
		.NLADirectionX "1"
		.NLADirectionY "0"
		.NLADirectionZ "0"
		.FrqType "all"
		.Type "Normal"
		.MaterialUnit "Frequency", "Hz"
		.MaterialUnit "Geometry", "mm"
		.MaterialUnit "Time", "s"
		.Epsilon "1"
		.Mu "1000"
		.Sigma "1.04e+007"
		.TanD "0.0"
		.TanDFreq "0.0"
		.TanDGiven "False"
		.TanDModel "ConstSigma"
		.SetConstTanDStrategyEps "AutomaticOrder"
		.ConstTanDModelOrderEps "1"
		.DjordjevicSarkarUpperFreqEps "0"
		.SetElParametricConductivity "False"
		.ReferenceCoordSystem "Global"
		.CoordSystemType "Cartesian"
		.SigmaM "0"
		.TanDM "0.0"
		.TanDMFreq "0.0"
		.TanDMGiven "False"
		.TanDMModel "ConstSigma"
		.SetConstTanDStrategyMu "AutomaticOrder"
		.ConstTanDModelOrderMu "1"
		.DjordjevicSarkarUpperFreqMu "0"
		.SetMagParametricConductivity "False"
		.DispModelEps  "None"
		.DispModelMu "None"
		.DispersiveFittingSchemeEps "Nth Order"
		.MaximalOrderNthModelFitEps "10"
		.ErrorLimitNthModelFitEps "0.1"
		.UseOnlyDataInSimFreqRangeNthModelEps "False"
		.DispersiveFittingSchemeMu "Nth Order"
		.MaximalOrderNthModelFitMu "10"
		.ErrorLimitNthModelFitMu "0.1"
		.UseOnlyDataInSimFreqRangeNthModelMu "False"
		.UseGeneralDispersionEps "False"
		.UseGeneralDispersionMu "False"
		.NonlinearMeasurementError "1e-3"
		.ResetHBList
		.SetNonlinearCurveType "Soft-Magnetic-BH"
		.AddNonlinearCurveValue " 0.000000e+000", " 0.000000e+000"
		.AddNonlinearCurveValue " 1.592000e+001", " 4.500000e-002"
		.AddNonlinearCurveValue " 3.183000e+001", " 4.900000e-001"
		.AddNonlinearCurveValue " 4.775000e+001", " 7.800000e-001"
		.AddNonlinearCurveValue " 6.366000e+001", " 9.900000e-001"
		.AddNonlinearCurveValue " 7.958000e+001", " 1.130000e+000"
		.AddNonlinearCurveValue " 1.592000e+002", " 1.420000e+000"
		.AddNonlinearCurveValue " 3.183000e+002", " 1.570000e+000"
		.AddNonlinearCurveValue " 4.775000e+002", " 1.621000e+000"
		.AddNonlinearCurveValue " 6.366000e+002", " 1.641000e+000"
		.AddNonlinearCurveValue " 7.958000e+002", " 1.656000e+000"
		.AddNonlinearCurveValue " 1.592000e+003", " 1.697000e+000"
		.AddNonlinearCurveValue " 3.183000e+003", " 1.764000e+000"
		.AddNonlinearCurveValue " 4.775000e+003", " 1.801000e+000"
		.AddNonlinearCurveValue " 6.366000e+003", " 1.838000e+000"
		.AddNonlinearCurveValue " 7.958000e+003", " 1.870000e+000"
		.AddNonlinearCurveValue " 1.592000e+004", " 2.000000e+000"
		.AddNonlinearCurveValue " 3.183000e+004", " 2.136000e+000"
		.AddNonlinearCurveValue " 4.775000e+004", " 2.185000e+000"
		.AddNonlinearCurveValue " 6.366000e+004", " 2.220000e+000"
		.AddNonlinearCurveValue " 7.958000e+004", " 2.250000e+000"
		.AddNonlinearCurveValue " 1.592000e+005", " 2.355000e+000"
		.AddNonlinearCurveValue " 3.183000e+005", " 2.556000e+000"
		.GenerateNonlinearCurve
		.NLAnisotropy "False"
		.NLAStackingFactor "1"
		.NLADirectionX "1"
		.NLADirectionY "0"
		.NLADirectionZ "0"
		.FrqType "hf"
		.Type "Lossy metal"
		.MaterialUnit "Frequency", "Hz"
		.MaterialUnit "Geometry", "mm"
		.MaterialUnit "Time", "s"
		.Mu "1"
		.Sigma "1.04e+007"
		.LossyMetalSIRoughness "0.0"
		.ReferenceCoordSystem "Global"
		.CoordSystemType "Cartesian"
		.NonlinearMeasurementError "1e-1"
		.NLAnisotropy "False"
		.NLAStackingFactor "1"
		.NLADirectionX "1"
		.NLADirectionY "0"
		.NLADirectionZ "0"
		.Colour "0", "0.168627", "0.211765" 
		.Wireframe "False" 
		.Reflection "False" 
		.Allowoutline "True" 
		.Transparentoutline "False" 
		.Transparency "0" 
		.Create
	End With

	' Vacuum
	With Material
		.Reset
		.Name "Vacuum"
		.Folder ""
		.FrqType "all"
		.Type "Normal"
		.SetMaterialUnit "Hz", "mm"
		.Mu "1.0"
		.Kappa "0"
		.TanD "0.0"
		.TanDFreq "0.0"
		.TanDGiven "False"
		.TanDModel "ConstKappa"
		.KappaM "0"
		.TanDM "0.0"
		.TanDMFreq "0.0"
		.TanDMGiven "False"
		.TanDMModel "ConstKappa"
		.DispModelEps "None"
		.DispModelMu "None"
		.DispersiveFittingSchemeEps "General 1st"
		.DispersiveFittingSchemeMu "General 1st"
		.UseGeneralDispersionEps "False"
		.UseGeneralDispersionMu "False"
		.Rho "0"
		.ThermalConductivity "0"
		.SetActiveMaterial "all"
		.Colour "1", "1", "1"
		.Wireframe "True"
		.Transparency "80"
		.Create
	End With

	' PEC
	With Material
		.Reset
		.Name "PEC"
		.Folder ""
		.FrqType "all"
		.Type "PEC"
		.SetMaterialUnit "Hz", "mm"
		.Epsilon "1"
		.Mu "1"
		.Rho "0"
		.ThermalType "PTC"
		.SetActiveMaterial "all"
		.Colour "0.8", "0.8", "0.8"
		.Wireframe "False"
		.Transparency "0"
		.Create
	End With

	' Epoxy resin
	With Material
		.Reset
		.Name "Epoxy resin"
		.Folder ""
		.Rho "1500"
		.ThermalType "Normal"
		.ThermalConductivity "0.2"
		.SpecificHeat "0", "J/K/kg"
		.DynamicViscosity "0"
		.Emissivity "0"
		.MetabolicRate "0.0"
		.VoxelConvection "0.0"
		.BloodFlow "0"
		.MechanicsType "Isotropic"
		.YoungsModulus "13"
		.PoissonsRatio "0.45"
		.ThermalExpansionRate "0.0"
		.FrqType "all"
		.Type "Normal"
		.MaterialUnit "Frequency", "GHz"
		.MaterialUnit "Geometry", "mm"
		.MaterialUnit "Time", "s"
		.Epsilon "5.2"
		.Mu "1"
		.Sigma "0"
		.TanD "0.0"
		.TanDFreq "0.0"
		.TanDGiven "False"
		.TanDModel "ConstTanD"
		.EnableUserConstTanDModelOrderEps "False"
		.ConstTanDModelOrderEps "1"
		.SetElParametricConductivity "False"
		.ReferenceCoordSystem "Global"
		.CoordSystemType "Cartesian"
		.SigmaM "0"
		.TanDM "0.0"
		.TanDMFreq "0.0"
		.TanDMGiven "False"
		.TanDMModel "ConstTanD"
		.EnableUserConstTanDModelOrderMu "False"
		.ConstTanDModelOrderMu "1"
		.SetMagParametricConductivity "False"
		.DispModelEps  "None"
		.DispModelMu "None"
		.DispersiveFittingSchemeEps "1st Order"
		.DispersiveFittingSchemeMu "1st Order"
		.UseGeneralDispersionEps "False"
		.UseGeneralDispersionMu "False"
		.NLAnisotropy "False"
		.NLAStackingFactor "1"
		.NLADirectionX "1"
		.NLADirectionY "0"
		.NLADirectionZ "0"
		.Colour "0.160784", "0.431373", "0.00392157"  
		.Wireframe "False"
		.Reflection "False"
		.Allowoutline "True"
		.Transparentoutline "False"
		.Transparency "0"
		.Create
	End With

	' Stainless steel
	With Material
		.Reset
		.Name "SS"
		.Folder "Folder1"
		.Rho "0.0"
		.ThermalType "Normal"
		.ThermalConductivity "0"
		.SpecificHeat "0", "J/K/kg"
		.DynamicViscosity "0"
		.Emissivity "0"
		.MetabolicRate "0.0"
		.VoxelConvection "0.0"
		.BloodFlow "0"
		.MechanicsType "Unused"
		.FrqType "all"
		.Type "Pec"
		.MaterialUnit "Frequency", "Hz"
		.MaterialUnit "Geometry", "m"
		.MaterialUnit "Time", "s"
		.MaterialUnit "Temperature", "Kelvin"
		.Epsilon "1.0"
		.Mu "1"
		.ReferenceCoordSystem "Global"
		.CoordSystemType "Cartesian"
		.NLAnisotropy "False"
		.NLAStackingFactor "1"
		.NLADirectionX "1"
		.NLADirectionY "0"
		.NLADirectionZ "0"
		.Colour "0.752941", "0.752941", "0.752941"
		.Wireframe "False"
		.Reflection "False"
		.Allowoutline "True"
		.Transparentoutline "False"
		.Transparency "50"
		.Create
	End With 
End Sub
Sub DefineComponents()

	With Units 
		.SetUnit "Length", "m"
		.SetUnit "Temperature", "degC"
		.SetUnit "Voltage", "V"
		.SetUnit "Current", "A"
		.SetUnit "Resistance", "Ohm"
		.SetUnit "Conductance", "S"
		.SetUnit "Capacitance", "pF"
		.SetUnit "Inductance", "nH"
		.SetUnit "Frequency", "GHz"
		.SetUnit "Time", "ns"
		.SetResultUnit "frequency", "frequency", "" 
	End With

	Component.New "magnet"
	Component.New "bounce_electrodes"
	Component.New "bounce_electrodes_2nd"
	Component.New "bounce_electrodes_3rd"
	Component.New "bounce_electrodes_4th"
	Component.New "bounce_electrodes_5th"
	Component.New "filter_electrodes"
	Component.New "filter_electrodes_2nd"
	Component.New "filter_electrodes_3rd"
	Component.New "filter_electrodes_4th"
	Component.New "filter_electrodes_5th"

	Component.New "paradrain_electrodes"
	Component.New "mesh"
	Component.New "target"

	Curve.NewCurve "magnet_curve"
	Curve.NewCurve "coil_curve"
	Curve.NewCurve "bounce_curve"
	Curve.NewCurve "electrode_curve"
	Curve.NewCurve "paradrain_curve"
End Sub
Sub Compute_Bfield_Only_No_Efield()
	ComputeB = True
	Bimport = False

	ComputeE = False
	Eimport = False
End Sub
Sub Import_Bfield_Compute_Efield()
	ComputeB = False
	Bimport = True

	ComputeE = True
	Eimport = False
End Sub
Sub Import_Bfield_Import_Efield()
	ComputeB = False
	Bimport = True

	ComputeE = False
	Eimport = True
End Sub
Sub SetSolvers()

	SetBoundary()
	SetBackground()
	SetEStaticSolver()
	SetMStaticSolver()

	SetImportedFields()
	SetTrackingSolver()
End Sub
Sub SetBoundary()
     With Boundary
          .Xmin boundarytype
          .Xmax boundarytype
          .Ymin boundarytype
          .Ymax boundarytype
          .Zmin boundarytype
          .Zmax boundarytype
          .Xsymmetry "none"
          .Ysymmetry "none"
          .Zsymmetry "none"
          .ApplyInAllDirections "True"
     End With
End Sub
Sub SetBackground()

     With Background
          .ResetBackground
          .XminSpace global_background_space_buffer
          .XmaxSpace global_background_space_buffer
          .YminSpace global_background_space_buffer
          .YmaxSpace global_background_space_buffer
          .ZminSpace zmin_background_space_buffer
          .ZmaxSpace zmax_background_space_buffer
          .ApplyInAllDirections "False"
     End With

	With Material 
		.Reset 
		.Rho "0"
		.ThermalType "Normal"
		.ThermalConductivity "0"
		.SpecificHeat "0", "J/K/kg"
		.DynamicViscosity "0"
		.UseEmissivity "True"
		.Emissivity "0"
		.MetabolicRate "0.0"
		.VoxelConvection "0.0"
		.BloodFlow "0"
		.MechanicsType "Unused"
		.IntrinsicCarrierDensity "0"
		.FrqType "all"
		.Type "Normal"
		.MaterialUnit "Frequency", "Hz"
		.MaterialUnit "Geometry", "mm"
		.MaterialUnit "Time", "s"
		.Epsilon "1.0"
		.Mu "1.0"
		.Sigma "0"
		.TanD "0.0"
		.TanDFreq "0.0"
		.TanDGiven "False"
		.TanDModel "ConstTanD"
		.SetConstTanDStrategyEps "AutomaticOrder"
		.ConstTanDModelOrderEps "3"
		.DjordjevicSarkarUpperFreqEps "0"
		.SetElParametricConductivity "False"
		.ReferenceCoordSystem "Global"
		.CoordSystemType "Cartesian"
		.SigmaM "0"
		.TanDM "0.0"
		.TanDMFreq "0.0"
		.TanDMGiven "False"
		.TanDMModel "ConstTanD"
		.SetConstTanDStrategyMu "AutomaticOrder"
		.ConstTanDModelOrderMu "3"
		.DjordjevicSarkarUpperFreqMu "0"
		.SetMagParametricConductivity "False"
		.DispModelEps  "None"
		.DispModelMu "None"
		.DispersiveFittingSchemeEps "1st Order"
		.DispersiveFittingSchemeMu "1st Order"
		.UseGeneralDispersionEps "False"
		.UseGeneralDispersionMu "False"
		.NLAnisotropy "False"
		.NLAStackingFactor "1"
		.NLADirectionX "1"
		.NLADirectionY "0"
		.NLADirectionZ "0"
		.Colour "0.5", "0.8", "1" 
		.Wireframe "False" 
		.Reflection "False" 
		.Allowoutline "True" 
		.Transparentoutline "False" 
		.Transparency "0" 
		.ChangeBackgroundMaterial
	End With
End Sub
Sub SetEStaticSolver()

	With EStaticSolver
	Mesh.SetCreator "Tracking" 

		.Method "Hexahedral Mesh"
		.Accuracy "1e-12"
		.CalcCapacitanceMatrix "False"
		.StoreResultsInCache "False"
		.MeshAdaption "False"
		.TetAdaption "False"
		.UseMaxNumberOfThreads "True"
		.MaxNumberOfThreads "48"
		.MaximumNumberOfCPUDevices "4"
		.UseDistributedComputing "False"
	End With
End Sub
Sub SetMStaticSolver()

	With MStaticSolver
	Mesh.SetCreator "Tracking" 

		.Method "Hexahedral Mesh"
		.Accuracy "1e-12"
		.ApparentInductanceMatrix "False"
		.IncrementalInductanceMatrix "False"
		.StoreResultsInCache "False"
		.MeshAdaption "False"
		.PrecomputeStationaryCurrentSource "False"
		.TetAdaption "False"
		.UseMaxNumberOfThreads "True"
		.MaxNumberOfThreads "48"
		.MaximumNumberOfCPUDevices "4"
		.UseDistributedComputing "False"
	End With
End Sub
Sub SetImportedFields()
     If (Eimport = True Or Bimport = True) Then
          With PredefinedField
          		.Reset
				.FieldType "External"
				.UseLocalCopyOnly "False"
				.UpdateLocalCopies "False"
				.ExternalFieldMur "1.0"
               If Eimport = True Then
                    .SetExternalField "True", e_field_file, "1.0", "0.0", "0", "False"
                    .SetExternalFieldDescription "0", "<mesh:hex><filename:field_se_e.m3d>"
                    .SetExternalFieldSpaceShift "0", "0.0", "0.0", "0.0"
                    .SetExternalFieldTimeSignal "0", "[Constant]"
                    .SetExternalFieldTimeShift "0", "0.0"
               End If
               If Bimport = True Then
                    .SetExternalField "True", b_field_file, "1.0", "0.0", "1", "False"
                    .SetExternalFieldDescription "1", "<mesh:hex><filename:field_sh_b.m3d>"
                    .SetExternalFieldSpaceShift "1", "0.0", "0.0", "0.0"
                    .SetExternalFieldTimeSignal "1", "[Constant]"
                    .SetExternalFieldTimeShift "1", "0.0"
                    ' .SetExternalField "True", b_field_file, "1.0", "0.0", "2", "False"
                    ' .SetExternalFieldDescription "2", "<mesh:hex><filename:field_sh_h.m3d>"
                    ' .SetExternalFieldSpaceShift "2", "0.0", "0.0", "0.0"
                    ' .SetExternalFieldTimeSignal "2", "[Constant]"
                    ' .SetExternalFieldTimeShift "2", "0.0"
               End If
               .Create
          End With
     End If
End Sub
Sub SetTrackingSolver()
	Mesh.SetCreator "Tracking" 
	Mesh.SetFlavor "Low Frequency" 
    With TrackingSolver

		.StoreResultsInDataCache "False"
		.Method "Hexahedral"
		.SolverOrderTet "2"
		.SetSimulationTime "5"
		.SetNumTimeIterations "1000"
		.SetNeglectSpaceCharge "False"
		.SetNeglectPECCharging "True"
		.MaxTimeSteps max_time_steps
		.SetTemporalDynamic "1"
		.SetSpatialSamplingRate trajectory_spatial_sampling_per_mesh_step
		.ConsiderSpacecharge "False"
		.SetGunIteration "False"
		.SetGunIterationMaxN "10"
		.SetGunIterationAccuracy "-30 dB"
		.SetGunIterationRelaxation "0.3"
		.SetGunIterationWithHField "False"
		If SaveTraj = False Then
			.SetTrajectorySampling "TRAJECTORIES_DISABLED", ""
		Else
			.SetTrajectorySampling "FIXED", trajectory_sampling_step_frequency
		End If
		.AddTrackingSource "all sources", ""
		If (Eimport = True Or Bimport = True) Then
		.AddStaticsField "External", "1.0", "False"
		End If
		If ComputeE = True Then
		.AddStaticsField "E-static", "1.0", "False"
		End If
		If ComputeB = True Then
		.AddStaticsField "M-static", "1.0", "False"
		End If
		.DefaultBoundaryEstatic "normal"
		.DefaultBoundaryMstatic boundarytype
		.ParticleSurfaceLosses "False", "False", "True", "", "", "False"
		.ParticleMerging "False", "100", "10"
	End With
	With TrackingSolver 
		.UseMaxNumberOfThreads "True"
		.MaxNumberOfThreads "1024"
		.MaximumNumberOfCPUDevices "2"
		.UseDistributedComputing "False"
	End With
	UseDistributedComputingForParameters "False"
	MaxNumberOfDistributedComputingParameters "2"
	UseDistributedComputingMemorySetting "False"
	MinDistributedComputingMemoryLimit "0"
	UseDistributedComputingSharedDirectory "False"
	OnlyConsider0D1DResultsForDC "False"
End Sub
Sub SetPTTracking()
	ChangeSolverType "PT Tracking"
End Sub
Sub SetPTMonitors()
	With Particle2DMonitor
		.Reset
		.Name "monitor1"
		.NumPlanes "51"
		.NormalDirection "2"
		.Limits "X", -filter_dimension_half_x, filter_dimension_half_x
		.Limits "Y", -filter_dimension_half_y_stage_2, filter_dimension_half_y_stage_2
		.Limits "Z", -1.5, -1.0
		.TimeSettings "0", "1", "0", "False"
		.Create
	End With
	With Particle2DMonitor
		.Reset
		.Name "monitor2"
		.NumPlanes "51"
		.NormalDirection "2"
		.Limits "X", -filter_dimension_half_x, filter_dimension_half_x
		.Limits "Y", -filter_dimension_half_y_stage_2, filter_dimension_half_y_stage_2
		.Limits "Z", -1.0, -0.5
		.TimeSettings "0", "1", "0", "False"
		.Create
	End With
	With Particle2DMonitor
		.Reset
		.Name "monitor3"
		.NumPlanes "51"
		.NormalDirection "2"
		.Limits "X", -filter_dimension_half_x, filter_dimension_half_x
		.Limits "Y", -filter_dimension_half_y_stage_2, filter_dimension_half_y_stage_2
		.Limits "Z", -0.5, 0.0
		.TimeSettings "0", "1", "0", "False"
		.Create
	End With
	With Particle2DMonitor
		.Reset
		.Name "monitor4"
		.NumPlanes "51"
		.NormalDirection "2"
		.Limits "X", -filter_dimension_half_x, filter_dimension_half_x
		.Limits "Y", -filter_dimension_half_y_stage_2, filter_dimension_half_y_stage_2
		.Limits "Z", 0.0, 0.5
		.TimeSettings "0", "1", "0", "False"
		.Create
	End With
	With Particle2DMonitor
		.Reset
		.Name "monitor5"
		.NumPlanes "51"
		.NormalDirection "2"
		.Limits "X", -filter_dimension_half_x, filter_dimension_half_x
		.Limits "Y", -filter_dimension_half_y_stage_2, filter_dimension_half_y_stage_2
		.Limits "Z", 0.5, 1.0
		.TimeSettings "0", "1", "0", "False"
		.Create
	End With
	With Particle2DMonitor
		.Reset
		.Name "monitor6"
		.NumPlanes "51"
		.NormalDirection "2"
		.Limits "X", -filter_dimension_half_x, filter_dimension_half_x
		.Limits "Y", -filter_dimension_half_y_stage_2, filter_dimension_half_y_stage_2
		.Limits "Z", 1.0, 1.5
		.TimeSettings "0", "1", "0", "False"
		.Create
	End With
End Sub

''''''' Sampled Bx and normalized/lambda shifted values from python notebook LNGS_target.ipynb

Sub Define_Bx_Normalized_Values()
	Bx_Normalized(  0    )    =  0.049460897181421194 	' z=-1.409 
	Bx_Normalized(  1    )    =  0.054761413259229855 	' z=-1.389 
	Bx_Normalized(  2    )    =  0.06075506153235411 	' z=-1.369 
	Bx_Normalized(  3    )    =  0.06754267566494641 	' z=-1.349 
	Bx_Normalized(  4    )    =  0.07524573243350535 	' z=-1.329 
	Bx_Normalized(  5    )    =  0.08400158793171894 	' z=-1.309 
	Bx_Normalized(  6    )    =  0.09398967844382691 	' z=-1.289 
	Bx_Normalized(  7    )    =  0.10539102818578801 	' z=-1.269 
	Bx_Normalized(  8    )    =  0.118459706232632 	' z=-1.249 
	Bx_Normalized(  9    )    =  0.13348154029376735 	' z=-1.229 
	Bx_Normalized(  10    )    =  0.15082175466454942 	' z=-1.209 
	Bx_Normalized(  11    )    =  0.1709011512504962 	' z=-1.189 
	Bx_Normalized(  12    )    =  0.19429138547042477 	' z=-1.169 
	Bx_Normalized(  13    )    =  0.22166732830488287 	' z=-1.149 
	Bx_Normalized(  14    )    =  0.25388646288209604 	' z=-1.129 
	Bx_Normalized(  15    )    =  0.2919888844779674 	' z=-1.109 
	Bx_Normalized(  16    )    =  0.33722111949186184 	' z=-1.089 
	Bx_Normalized(  17    )    =  0.39095672886065896 	' z=-1.069 
	Bx_Normalized(  18    )    =  0.45452957522826515 	' z=-1.049 
	Bx_Normalized(  19    )    =  0.5288844779674474 	' z=-1.029 
	Bx_Normalized(  20    )    =  0.6139102818578801 	' z=-1.009 
	Bx_Normalized(  21    )    =  0.7070821754664549 	' z=-0.989 
	Bx_Normalized(  22    )    =  0.8011115522032551 	' z=-0.969 
	Bx_Normalized(  23    )    =  0.8828106391425169 	' z=-0.949 
	Bx_Normalized(  24    )    =  0.9400555776101627 	' z=-0.929 
	Bx_Normalized(  25    )    =  0.9722905915045652 	' z=-0.909 
	Bx_Normalized(  26    )    =  0.9878523223501389 	' z=-0.889 
	Bx_Normalized(  27    )    =  0.9947598253275108 	' z=-0.869 
	Bx_Normalized(  28    )    =  0.9976974990075426 	' z=-0.849 
	Bx_Normalized(  29    )    =  0.9989678443826915 	' z=-0.829 
	Bx_Normalized(  30    )    =  0.9995236204843191 	' z=-0.809 
	Bx_Normalized(  31    )    =  0.9997618102421596 	' z=-0.789 
	Bx_Normalized(  32    )    =  0.9998412068281064 	' z=-0.769 
	Bx_Normalized(  33    )    =  0.9999206034140532 	' z=-0.749 
	Bx_Normalized(  34    )    =  0.9999206034140532 	' z=-0.729 
	Bx_Normalized(  35    )    =  0.9999206034140532 	' z=-0.709 
	Bx_Normalized(  36    )    =  0.9999206034140532 	' z=-0.689 
	Bx_Normalized(  37    )    =  0.9999206034140532 	' z=-0.669 
	Bx_Normalized(  38    )    =  1.0 	' z=-0.649 
	Bx_Normalized(  39    )    =  1.0 	' z=-0.629 
	Bx_Normalized(  40    )    =  1.0 	' z=-0.609 
	Bx_Normalized(  41    )    =  1.0 	' z=-0.589 
	Bx_Normalized(  42    )    =  1.0 	' z=-0.569 
	Bx_Normalized(  43    )    =  1.0 	' z=-0.549 
	Bx_Normalized(  44    )    =  1.0 	' z=-0.529 
	Bx_Normalized(  45    )    =  1.0 	' z=-0.509 
	Bx_Normalized(  46    )    =  1.0 	' z=-0.489 
	Bx_Normalized(  47    )    =  1.0 	' z=-0.469 
	Bx_Normalized(  48    )    =  1.0 	' z=-0.449 
	Bx_Normalized(  49    )    =  1.0 	' z=-0.429 
	Bx_Normalized(  50    )    =  1.0 	' z=-0.409 
	Bx_Normalized(  51    )    =  1.0 	' z=-0.389 
	Bx_Normalized(  52    )    =  1.0 	' z=-0.369 
	Bx_Normalized(  53    )    =  0.9999206034140532 	' z=-0.349 
	Bx_Normalized(  54    )    =  0.9999206034140532 	' z=-0.329 
	Bx_Normalized(  55    )    =  0.9999206034140532 	' z=-0.309 
	Bx_Normalized(  56    )    =  0.9999206034140532 	' z=-0.289 
	Bx_Normalized(  57    )    =  0.9999206034140532 	' z=-0.269 
	Bx_Normalized(  58    )    =  0.9999206034140532 	' z=-0.249 
	Bx_Normalized(  59    )    =  0.9998412068281064 	' z=-0.229 
	Bx_Normalized(  60    )    =  0.9998412068281064 	' z=-0.209 
	Bx_Normalized(  61    )    =  0.9997618102421596 	' z=-0.189 
	Bx_Normalized(  62    )    =  0.9996030170702659 	' z=-0.169 
	Bx_Normalized(  63    )    =  0.9993648273124255 	' z=-0.149 
	Bx_Normalized(  64    )    =  0.9988884477967447 	' z=-0.129 
	Bx_Normalized(  65    )    =  0.9976181024215958 	' z=-0.109 
	Bx_Normalized(  66    )    =  0.9946010321556172 	' z=-0.089 
	Bx_Normalized(  67    )    =  0.9876935291782453 	' z=-0.069 
	Bx_Normalized(  68    )    =  0.9718142119888844 	' z=-0.049 
	Bx_Normalized(  69    )    =  0.9377530766177055 	' z=-0.029 
	Bx_Normalized(  70    )    =  0.873838824930528 	' z=-0.009 
	Bx_Normalized(  71    )    =  0.7822469233822945 	' z=0.01 
	Bx_Normalized(  72    )    =  0.6680349344978166 	' z=0.03 
	Bx_Normalized(  73    )    =  0.5576022231044065 	' z=0.05 
	Bx_Normalized(  74    )    =  0.46345375148868595 	' z=0.07 
	Bx_Normalized(  75    )    =  0.3873997618102421 	' z=0.09 
	Bx_Normalized(  76    )    =  0.3267804684398571 	' z=0.11 
	Bx_Normalized(  77    )    =  0.2782056371576022 	' z=0.13 
	Bx_Normalized(  78    )    =  0.23882493052798728 	' z=0.15 
	Bx_Normalized(  79    )    =  0.20647082175466455 	' z=0.17 
	Bx_Normalized(  80    )    =  0.17956331877729256 	' z=0.19 
	Bx_Normalized(  81    )    =  0.15694323144104805 	' z=0.21 
	Bx_Normalized(  82    )    =  0.13775307661770542 	' z=0.23 
	Bx_Normalized(  83    )    =  0.12134180230250098 	' z=0.25 
	Bx_Normalized(  84    )    =  0.1072171496625645 	' z=0.27 
	Bx_Normalized(  85    )    =  0.09499007542675664 	' z=0.29 
	Bx_Normalized(  86    )    =  0.08436681222707422 	' z=0.31 
	Bx_Normalized(  87    )    =  0.07510202461294163 	' z=0.33 
	Bx_Normalized(  88    )    =  0.06698769352917824 	' z=0.35 
	Bx_Normalized(  89    )    =  0.059864231838030954 	' z=0.37 
	Bx_Normalized(  90    )    =  0.053593489479952364 	' z=0.39 
	Bx_Normalized(  91    )    =  0.04806113537117904 	' z=0.41 
	Bx_Normalized(  92    )    =  0.04316951171099642 	' z=0.43 
	Bx_Normalized(  93    )    =  0.03883604605001985 	' z=0.45 
	Bx_Normalized(  94    )    =  0.034990075426756646 	' z=0.47 
	Bx_Normalized(  95    )    =  0.03157046447002779 	' z=0.49 
	Bx_Normalized(  96    )    =  0.028525605398967844 	' z=0.51 
	Bx_Normalized(  97    )    =  0.025809448193727668 	' z=0.53 
	Bx_Normalized(  98    )    =  0.023382294561333863 	' z=0.55 
	Bx_Normalized(  99    )    =  0.021211591901548234 	' z=0.57 
	Bx_Normalized(  100    )    =  0.019267169511710997 	' z=0.59 
	Bx_Normalized(  101    )    =  0.017522032552600236 	' z=0.61 
	Bx_Normalized(  102    )    =  0.015953949980150855 	' z=0.63 
	Bx_Normalized(  103    )    =  0.01454386661373561 	' z=0.65 
	Bx_Normalized(  104    )    =  0.01327352123858674 	' z=0.67 
	Bx_Normalized(  105    )    =  0.012127828503374355 	' z=0.69 
	Bx_Normalized(  106    )    =  0.011093290988487494 	' z=0.71 
	Bx_Normalized(  107    )    =  0.01015799920603414 	' z=0.73 
	Bx_Normalized(  108    )    =  0.009311631599841207 	' z=0.75 
	Bx_Normalized(  109    )    =  0.008544660579595078 	' z=0.77 
	Bx_Normalized(  110    )    =  0.007848590710599443 	' z=0.79 
	Bx_Normalized(  111    )    =  0.007216752679634775 	' z=0.81 
	Bx_Normalized(  112    )    =  0.0066423977768955925 	' z=0.83 
	Bx_Normalized(  113    )    =  0.006119809448193727 	' z=0.85 
	Bx_Normalized(  114    )    =  0.005643826915442636 	' z=0.87 
	Bx_Normalized(  115    )    =  0.005209845176657403 	' z=0.89 
	Bx_Normalized(  116    )    =  0.004813894402540691 	' z=0.91 
	Bx_Normalized(  117    )    =  0.004452242953552997 	' z=0.93 
	Bx_Normalized(  118    )    =  0.004121635569670504 	' z=0.95 
	Bx_Normalized(  119    )    =  0.0038192139737991265 	' z=0.97 
	Bx_Normalized(  120    )    =  0.0035423580786026194 	' z=0.99 
	Bx_Normalized(  121    )    =  0.00328868598650258 	' z=1.01 
	Bx_Normalized(  122    )    =  0.0030560539896784433 	' z=1.03 
	Bx_Normalized(  123    )    =  0.0028426359666534336 	' z=1.05 
	Bx_Normalized(  124    )    =  0.002646605795950774 	' z=1.07 
	Bx_Normalized(  125    )    =  0.002466613735609369 	' z=1.09 
	Bx_Normalized(  126    )    =  0.002301071853910282 	' z=1.11 
	Bx_Normalized(  127    )    =  0.0021488685986502582 	' z=1.13 
	Bx_Normalized(  128    )    =  0.0020087336244541485 	' z=1.15 
	Bx_Normalized(  129    )    =  0.0018797935688765384 	' z=1.17 
	Bx_Normalized(  130    )    =  0.0017610162763001189 	' z=1.19 
	Bx_Normalized(  131    )    =  0.0016516077808654227 	' z=1.21 
	Bx_Normalized(  132    )    =  0.0015506947201270344 	' z=1.23 
	Bx_Normalized(  133    )    =  0.0014578007145692735 	' z=1.25 
	Bx_Normalized(  134    )    =  0.0013721317983326716 	' z=1.27 
	Bx_Normalized(  135    )    =  0.0012931321953156014 	' z=1.29 
	Bx_Normalized(  136    )    =  0.0012204049225883287 	' z=1.31 
	Bx_Normalized(  137    )    =  0.001153314807463279 	' z=1.33 
	Bx_Normalized(  138    )    =  0.0010915442635966654 	' z=1.35 
	Bx_Normalized(  139    )    =  0.0010346963080587535 	' z=1.37 
	Bx_Normalized(  140    )    =  0.0009824533545057562 	' z=1.39 
	Bx_Normalized(  141    )    =  0.0009343390234219928 	' z=1.41 
	Bx_Normalized(  142    )    =  0.0008902739182215164 	' z=1.43 
	Bx_Normalized(  143    )    =  0.0008499404525605399 	' z=1.45 
	Bx_Normalized(  144    )    =  0.0008130210400952759 	' z=1.47 
	Bx_Normalized(  145    )    =  0.0007793648273124254 	' z=1.49 
End Sub
Sub Define_Bx_Lambda_Adjusted_Values_Filter()
	Bx_Lambda_Adjusted_Filter(  0    )    =  0.049460897181421194
	Bx_Lambda_Adjusted_Filter(  1    )    =  0.06106352180851241
	Bx_Lambda_Adjusted_Filter(  2    )    =  0.07495727333737724
	Bx_Lambda_Adjusted_Filter(  3    )    =  0.0914641086984564
	Bx_Lambda_Adjusted_Filter(  4    )    =  0.11091993153436168
	Bx_Lambda_Adjusted_Filter(  5    )    =  0.13365450148770602
	Bx_Lambda_Adjusted_Filter(  6    )    =  0.16000631631467016
	Bx_Lambda_Adjusted_Filter(  7    )    =  0.19024694238081347
	Bx_Lambda_Adjusted_Filter(  8    )    =  0.22464639615987894
	Bx_Lambda_Adjusted_Filter(  9    )    =  0.2633853113622894
	Bx_Lambda_Adjusted_Filter(  10    )    =  0.3065772986356792
	Bx_Lambda_Adjusted_Filter(  11    )    =  0.3541911297205749
	Bx_Lambda_Adjusted_Filter(  12    )    =  0.40611539204748637
	Bx_Lambda_Adjusted_Filter(  13    )    =  0.4620320627764421
	Bx_Lambda_Adjusted_Filter(  14    )    =  0.5214393285899699
	Bx_Lambda_Adjusted_Filter(  15    )    =  0.5835764590455962
	Bx_Lambda_Adjusted_Filter(  16    )    =  0.6473898801435173
	Bx_Lambda_Adjusted_Filter(  17    )    =  0.7114537141552071
	Bx_Lambda_Adjusted_Filter(  18    )    =  0.7739407211177982
	Bx_Lambda_Adjusted_Filter(  19    )    =  0.832657189181192
	Bx_Lambda_Adjusted_Filter(  20    )    =  0.8851690630123321
	Bx_Lambda_Adjusted_Filter(  21    )    =  0.9169960656827989
	Bx_Lambda_Adjusted_Filter(  22    )    =  0.9460699508387761
	Bx_Lambda_Adjusted_Filter(  23    )    =  0.9693193660443378
	Bx_Lambda_Adjusted_Filter(  24    )    =  0.9846647312784118
	Bx_Lambda_Adjusted_Filter(  25    )    =  0.9929994794196498
	Bx_Lambda_Adjusted_Filter(  26    )    =  0.996949147410013
	Bx_Lambda_Adjusted_Filter(  27    )    =  0.9986873741126925
	Bx_Lambda_Adjusted_Filter(  28    )    =  0.9994238770666319
	Bx_Lambda_Adjusted_Filter(  29    )    =  0.9997418611593815
	Bx_Lambda_Adjusted_Filter(  30    )    =  0.9998808838397804
	Bx_Lambda_Adjusted_Filter(  31    )    =  0.9999404472409544
	Bx_Lambda_Adjusted_Filter(  32    )    =  0.9999602993428759
	Bx_Lambda_Adjusted_Filter(  33    )    =  0.999980150262503
	Bx_Lambda_Adjusted_Filter(  34    )    =  0.999980150262503
	Bx_Lambda_Adjusted_Filter(  35    )    =  0.999980150262503
	Bx_Lambda_Adjusted_Filter(  36    )    =  0.999980150262503
	Bx_Lambda_Adjusted_Filter(  37    )    =  0.999980150262503
	Bx_Lambda_Adjusted_Filter(  38    )    =  1.0
	Bx_Lambda_Adjusted_Filter(  39    )    =  1.0
	Bx_Lambda_Adjusted_Filter(  40    )    =  1.0
	Bx_Lambda_Adjusted_Filter(  41    )    =  1.0
	Bx_Lambda_Adjusted_Filter(  42    )    =  1.0
	Bx_Lambda_Adjusted_Filter(  43    )    =  1.0
	Bx_Lambda_Adjusted_Filter(  44    )    =  1.0
	Bx_Lambda_Adjusted_Filter(  45    )    =  1.0
	Bx_Lambda_Adjusted_Filter(  46    )    =  1.0
	Bx_Lambda_Adjusted_Filter(  47    )    =  1.0
	Bx_Lambda_Adjusted_Filter(  48    )    =  1.0
	Bx_Lambda_Adjusted_Filter(  49    )    =  1.0
	Bx_Lambda_Adjusted_Filter(  50    )    =  1.0
	Bx_Lambda_Adjusted_Filter(  51    )    =  1.0
	Bx_Lambda_Adjusted_Filter(  52    )    =  1.0
	Bx_Lambda_Adjusted_Filter(  53    )    =  0.9999523612919458
	Bx_Lambda_Adjusted_Filter(  54    )    =  0.9999523612919458
	Bx_Lambda_Adjusted_Filter(  55    )    =  0.9999523612919458
	Bx_Lambda_Adjusted_Filter(  56    )    =  0.9999523612919458
	Bx_Lambda_Adjusted_Filter(  57    )    =  0.9999523612919458
	Bx_Lambda_Adjusted_Filter(  58    )    =  0.9999523612919458
	Bx_Lambda_Adjusted_Filter(  59    )    =  0.999904721070807
	Bx_Lambda_Adjusted_Filter(  60    )    =  0.999904721070807
	Bx_Lambda_Adjusted_Filter(  61    )    =  0.9998570793364157
	Bx_Lambda_Adjusted_Filter(  62    )    =  0.9997617913272016
	Bx_Lambda_Adjusted_Filter(  63    )    =  0.9996188479597783
	Bx_Lambda_Adjusted_Filter(  64    )    =  0.9993329203352903
	Bx_Lambda_Adjusted_Filter(  65    )    =  0.9985701798827868
	Bx_Lambda_Adjusted_Filter(  66    )    =  0.996757112589334
	Bx_Lambda_Adjusted_Filter(  67    )    =  0.9925978384497643
	Bx_Lambda_Adjusted_Filter(  68    )    =  0.9829919189895041
	Bx_Lambda_Adjusted_Filter(  69    )    =  0.9621728511516721
	Bx_Lambda_Adjusted_Filter(  70    )    =  0.9222715290755822
	Bx_Lambda_Adjusted_Filter(  71    )    =  0.8629911026991273
	Bx_Lambda_Adjusted_Filter(  72    )    =  0.785017800393497
	Bx_Lambda_Adjusted_Filter(  73    )    =  0.7043600213512268
	Bx_Lambda_Adjusted_Filter(  74    )    =  0.6303820543072486
	Bx_Lambda_Adjusted_Filter(  75    )    =  0.5661031997357187
	Bx_Lambda_Adjusted_Filter(  76    )    =  0.5111562255648818
	Bx_Lambda_Adjusted_Filter(  77    )    =  0.4641085352008455
	Bx_Lambda_Adjusted_Filter(  78    )    =  0.4234945210718836
	Bx_Lambda_Adjusted_Filter(  79    )    =  0.38807459396722804
	Bx_Lambda_Adjusted_Filter(  80    )    =  0.3568868731173669
	Bx_Lambda_Adjusted_Filter(  81    )    =  0.3291891816320515
	Bx_Lambda_Adjusted_Filter(  82    )    =  0.3044113102381273
	Bx_Lambda_Adjusted_Filter(  83    )    =  0.28210206470378457
	Bx_Lambda_Adjusted_Filter(  84    )    =  0.26191390424760697
	Bx_Lambda_Adjusted_Filter(  85    )    =  0.2435605463113465
	Bx_Lambda_Adjusted_Filter(  86    )    =  0.22683130107382915
	Bx_Lambda_Adjusted_Filter(  87    )    =  0.21153926301144843
	Bx_Lambda_Adjusted_Filter(  88    )    =  0.1975136045770959
	Bx_Lambda_Adjusted_Filter(  89    )    =  0.1846292257547549
	Bx_Lambda_Adjusted_Filter(  90    )    =  0.17276955751413375
	Bx_Lambda_Adjusted_Filter(  91    )    =  0.16183647697132686
	Bx_Lambda_Adjusted_Filter(  92    )    =  0.15174216699626672
	Bx_Lambda_Adjusted_Filter(  93    )    =  0.14241016985527577
	Bx_Lambda_Adjusted_Filter(  94    )    =  0.13377252580362278
	Bx_Lambda_Adjusted_Filter(  95    )    =  0.12576754479766905
	Bx_Lambda_Adjusted_Filter(  96    )    =  0.11834254974906773
	Bx_Lambda_Adjusted_Filter(  97    )    =  0.1114467047096222
	Bx_Lambda_Adjusted_Filter(  98    )    =  0.1050345735185849
	Bx_Lambda_Adjusted_Filter(  99    )    =  0.09907040942145444
	Bx_Lambda_Adjusted_Filter(  100    )    =  0.09351703976150631
	Bx_Lambda_Adjusted_Filter(  101    )    =  0.08833863609903642
	Bx_Lambda_Adjusted_Filter(  102    )    =  0.08350662577692831
	Bx_Lambda_Adjusted_Filter(  103    )    =  0.07899651450430419
	Bx_Lambda_Adjusted_Filter(  104    )    =  0.07478107249674878
	Bx_Lambda_Adjusted_Filter(  105    )    =  0.07083857695391471
	Bx_Lambda_Adjusted_Filter(  106    )    =  0.0671484887863817
	Bx_Lambda_Adjusted_Filter(  107    )    =  0.06369200268328835
	Bx_Lambda_Adjusted_Filter(  108    )    =  0.06045266780999522
	Bx_Lambda_Adjusted_Filter(  109    )    =  0.0574138789784025
	Bx_Lambda_Adjusted_Filter(  110    )    =  0.054560081353208716
	Bx_Lambda_Adjusted_Filter(  111    )    =  0.05188061233100383
	Bx_Lambda_Adjusted_Filter(  112    )    =  0.04936224778537515
	Bx_Lambda_Adjusted_Filter(  113    )    =  0.04699403541847515
	Bx_Lambda_Adjusted_Filter(  114    )    =  0.044765579594916
	Bx_Lambda_Adjusted_Filter(  115    )    =  0.04266727337357648
	Bx_Lambda_Adjusted_Filter(  116    )    =  0.040690959959880466
	Bx_Lambda_Adjusted_Filter(  117    )    =  0.038828204933323306
	Bx_Lambda_Adjusted_Filter(  118    )    =  0.03707163611828568
	Bx_Lambda_Adjusted_Filter(  119    )    =  0.035414767453195536
	Bx_Lambda_Adjusted_Filter(  120    )    =  0.03385130967520681
	Bx_Lambda_Adjusted_Filter(  121    )    =  0.03237527340322769
	Bx_Lambda_Adjusted_Filter(  122    )    =  0.030981084299173
	Bx_Lambda_Adjusted_Filter(  123    )    =  0.029664207340032413
	Bx_Lambda_Adjusted_Filter(  124    )    =  0.028419311713254368
	Bx_Lambda_Adjusted_Filter(  125    )    =  0.027243361132388916
	Bx_Lambda_Adjusted_Filter(  126    )    =  0.026131125044884386
	Bx_Lambda_Adjusted_Filter(  127    )    =  0.025079906654790183
	Bx_Lambda_Adjusted_Filter(  128    )    =  0.024085374839409875
	Bx_Lambda_Adjusted_Filter(  129    )    =  0.02314547487833475
	Bx_Lambda_Adjusted_Filter(  130    )    =  0.02225655907067233
	Bx_Lambda_Adjusted_Filter(  131    )    =  0.021416285713846028
	Bx_Lambda_Adjusted_Filter(  132    )    =  0.020621287867144768
	Bx_Lambda_Adjusted_Filter(  133    )    =  0.019870962111016046
	Bx_Lambda_Adjusted_Filter(  134    )    =  0.01916185270098741
	Bx_Lambda_Adjusted_Filter(  135    )    =  0.018492079621896744
	Bx_Lambda_Adjusted_Filter(  136    )    =  0.017860860169161757
	Bx_Lambda_Adjusted_Filter(  137    )    =  0.017265084998886744
	Bx_Lambda_Adjusted_Filter(  138    )    =  0.016704166529728375
	Bx_Lambda_Adjusted_Filter(  139    )    =  0.016176618359021438
	Bx_Lambda_Adjusted_Filter(  140    )    =  0.01568148416738945
	Bx_Lambda_Adjusted_Filter(  141    )    =  0.015216076839267885
	Bx_Lambda_Adjusted_Filter(  142    )    =  0.014781353050875978
	Bx_Lambda_Adjusted_Filter(  143    )    =  0.014375835675407575
	Bx_Lambda_Adjusted_Filter(  144    )    =  0.013997841476481325
	Bx_Lambda_Adjusted_Filter(  145    )    =  0.013647229071424781
End Sub
Sub Define_Bx_Lambda_Adjusted_Values_Bounce()
	Bx_Lambda_Adjusted_Bounce(  0    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  1    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  2    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  3    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  4    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  5    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  6    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  7    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  8    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  9    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  10    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  11    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  12    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  13    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  14    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  15    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  16    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  17    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  18    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  19    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  20    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  21    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  22    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  23    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  24    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  25    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  26    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  27    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  28    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  29    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  30    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  31    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  32    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  33    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  34    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  35    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  36    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  37    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  38    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  39    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  40    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  41    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  42    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  43    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  44    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  45    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  46    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  47    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  48    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  49    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  50    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  51    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  52    )    =  1.0
	Bx_Lambda_Adjusted_Bounce(  53    )    =  0.9999603009190181
	Bx_Lambda_Adjusted_Bounce(  54    )    =  0.9999603009190181
	Bx_Lambda_Adjusted_Bounce(  55    )    =  0.9999603009190181
	Bx_Lambda_Adjusted_Bounce(  56    )    =  0.9999603009190181
	Bx_Lambda_Adjusted_Bounce(  57    )    =  0.9999603009190181
	Bx_Lambda_Adjusted_Bounce(  58    )    =  0.9999603009190181
	Bx_Lambda_Adjusted_Bounce(  59    )    =  0.999920600261894
	Bx_Lambda_Adjusted_Bounce(  60    )    =  0.999920600261894
	Bx_Lambda_Adjusted_Bounce(  61    )    =  0.9998808980284399
	Bx_Lambda_Adjusted_Bounce(  62    )    =  0.999801488831791
	Bx_Lambda_Adjusted_Bounce(  63    )    =  0.9996823632096474
	Bx_Lambda_Adjusted_Bounce(  64    )    =  0.999444069368939
	Bx_Lambda_Adjusted_Bounce(  65    )    =  0.9988083411854327
	Bx_Lambda_Adjusted_Bounce(  66    )    =  0.9972968626019122
	Bx_Lambda_Adjusted_Bounce(  67    )    =  0.993827716044509
	Bx_Lambda_Adjusted_Bounce(  68    )    =  0.9858063765207062
	Bx_Lambda_Adjusted_Bounce(  69    )    =  0.9683765159367019
	Bx_Lambda_Adjusted_Bounce(  70    )    =  0.934793466456911
	Bx_Lambda_Adjusted_Bounce(  71    )    =  0.8844472417178395
	Bx_Lambda_Adjusted_Bounce(  72    )    =  0.8173340409513216
	Bx_Lambda_Adjusted_Bounce(  73    )    =  0.7467276766696187
	Bx_Lambda_Adjusted_Bounce(  74    )    =  0.6807743763455598
	Bx_Lambda_Adjusted_Bounce(  75    )    =  0.6224144614404795
	Bx_Lambda_Adjusted_Bounce(  76    )    =  0.5716471537931918
	Bx_Lambda_Adjusted_Bounce(  77    )    =  0.5274520235600602
	Bx_Lambda_Adjusted_Bounce(  78    )    =  0.488697176713747
	Bx_Lambda_Adjusted_Bounce(  79    )    =  0.4543906048265793
	Bx_Lambda_Adjusted_Bounce(  80    )    =  0.423749122450174
	Bx_Lambda_Adjusted_Bounce(  81    )    =  0.3961606131874395
	Bx_Lambda_Adjusted_Bounce(  82    )    =  0.3711510159189995
	Bx_Lambda_Adjusted_Bounce(  83    )    =  0.34834150241178696
	Bx_Lambda_Adjusted_Bounce(  84    )    =  0.3274402993868722
	Bx_Lambda_Adjusted_Bounce(  85    )    =  0.3082045999441875
	Bx_Lambda_Adjusted_Bounce(  86    )    =  0.2904596567977629
	Bx_Lambda_Adjusted_Bounce(  87    )    =  0.27404748605477414
	Bx_Lambda_Adjusted_Bounce(  88    )    =  0.2588198089968738
	Bx_Lambda_Adjusted_Bounce(  89    )    =  0.24467168172477777
	Bx_Lambda_Adjusted_Bounce(  90    )    =  0.23150267704705352
	Bx_Lambda_Adjusted_Bounce(  91    )    =  0.2192285003624735
	Bx_Lambda_Adjusted_Bounce(  92    )    =  0.20777274053878295
	Bx_Lambda_Adjusted_Bounce(  93    )    =  0.19706863284150486
	Bx_Lambda_Adjusted_Bounce(  94    )    =  0.18705634292040632
	Bx_Lambda_Adjusted_Bounce(  95    )    =  0.17768079375674733
	Bx_Lambda_Adjusted_Bounce(  96    )    =  0.1688952497821293
	Bx_Lambda_Adjusted_Bounce(  97    )    =  0.1606531922923652
	Bx_Lambda_Adjusted_Bounce(  98    )    =  0.1529127024198247
	Bx_Lambda_Adjusted_Bounce(  99    )    =  0.14564199909898323
	Bx_Lambda_Adjusted_Bounce(  100    )    =  0.13880623008968654
	Bx_Lambda_Adjusted_Bounce(  101    )    =  0.13237081458010386
	Bx_Lambda_Adjusted_Bounce(  102    )    =  0.12630894655625488
	Bx_Lambda_Adjusted_Bounce(  103    )    =  0.12059795443429216
	Bx_Lambda_Adjusted_Bounce(  104    )    =  0.11521076876137377
	Bx_Lambda_Adjusted_Bounce(  105    )    =  0.11012642055099382
	Bx_Lambda_Adjusted_Bounce(  106    )    =  0.105324693156389
	Bx_Lambda_Adjusted_Bounce(  107    )    =  0.10078689997233838
	Bx_Lambda_Adjusted_Bounce(  108    )    =  0.09649679580090319
	Bx_Lambda_Adjusted_Bounce(  109    )    =  0.09243733325661811
	Bx_Lambda_Adjusted_Bounce(  110    )    =  0.08859227229617402
	Bx_Lambda_Adjusted_Bounce(  111    )    =  0.08495147249833152
	Bx_Lambda_Adjusted_Bounce(  112    )    =  0.08150090660167893
	Bx_Lambda_Adjusted_Bounce(  113    )    =  0.07822921096491851
	Bx_Lambda_Adjusted_Bounce(  114    )    =  0.07512540792197162
	Bx_Lambda_Adjusted_Bounce(  115    )    =  0.0721792572465068
	Bx_Lambda_Adjusted_Bounce(  116    )    =  0.0693822340555613
	Bx_Lambda_Adjusted_Bounce(  117    )    =  0.06672512985040192
	Bx_Lambda_Adjusted_Bounce(  118    )    =  0.06419996549586693
	Bx_Lambda_Adjusted_Bounce(  119    )    =  0.06179978943167304
	Bx_Lambda_Adjusted_Bounce(  120    )    =  0.05951771230988822
	Bx_Lambda_Adjusted_Bounce(  121    )    =  0.05734706606708472
	Bx_Lambda_Adjusted_Bounce(  122    )    =  0.05528158816168764
	Bx_Lambda_Adjusted_Bounce(  123    )    =  0.05331637615830087
	Bx_Lambda_Adjusted_Bounce(  124    )    =  0.0514451727176688
	Bx_Lambda_Adjusted_Bounce(  125    )    =  0.04966501520798487
	Bx_Lambda_Adjusted_Bounce(  126    )    =  0.04796948878099788
	Bx_Lambda_Adjusted_Bounce(  127    )    =  0.04635589065750175
	Bx_Lambda_Adjusted_Bounce(  128    )    =  0.04481889807273432
	Bx_Lambda_Adjusted_Bounce(  129    )    =  0.04335658622258605
	Bx_Lambda_Adjusted_Bounce(  130    )    =  0.0419644644467211
	Bx_Lambda_Adjusted_Bounce(  131    )    =  0.04063997761890898
	Bx_Lambda_Adjusted_Bounce(  132    )    =  0.039378861336090386
	Bx_Lambda_Adjusted_Bounce(  133    )    =  0.03818115653786922
	Bx_Lambda_Adjusted_Bounce(  134    )    =  0.03704229742244225
	Bx_Lambda_Adjusted_Bounce(  135    )    =  0.035960147320549196
	Bx_Lambda_Adjusted_Bounce(  136    )    =  0.03493429436224995
	Bx_Lambda_Adjusted_Bounce(  137    )    =  0.033960488916729085
	Bx_Lambda_Adjusted_Bounce(  138    )    =  0.03303852695863824
	Bx_Lambda_Adjusted_Bounce(  139    )    =  0.03216669563475169
	Bx_Lambda_Adjusted_Bounce(  140    )    =  0.031344111959118515
	Bx_Lambda_Adjusted_Bounce(  141    )    =  0.030566959669257144
	Bx_Lambda_Adjusted_Bounce(  142    )    =  0.029837458306992512
	Bx_Lambda_Adjusted_Bounce(  143    )    =  0.029153738226178474
	Bx_Lambda_Adjusted_Bounce(  144    )    =  0.028513523810558314
	Bx_Lambda_Adjusted_Bounce(  145    )    =  0.02791710635636196
End Sub